name: Pytest

on:
  push:
  workflow_dispatch:
  issue_comment:
    types: [created]

jobs:
  non-billable:
    name: Non-Billable Tests
    if: github.event_name != 'issue_comment'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/non-billable

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export AO_DB_PATH="$HOME/.cache/ao/tests/non-billable"
        export PYTHON_PORT=5959
        source $HOME/miniconda/bin/activate ao
        ao-server start

    - name: Run tests
      env:
        AO_DB_PATH: ~/.cache/ao/tests/non-billable
        PYTHON_PORT: 5959
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate ao
        pytest -v -s tests/non_billable/

    - name: Clean up
      if: always()
      run: rm -rf ~/.cache/ao/tests/non-billable

  billable-permission-check:
    name: Billable Tests / Permission Check
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/run-billable-tests')
    runs-on: ubuntu-latest
    outputs:
      has_permission: ${{ steps.check.outputs.has_permission }}
      ref: ${{ steps.get-ref.outputs.ref }}
    steps:
      - name: Add eyes reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Check permissions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            const hasPermission = ['admin', 'write'].includes(permission.permission);
            core.setOutput('has_permission', hasPermission);
            
            if (!hasPermission) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: '-1'
              });
              core.setFailed(`User ${context.actor} does not have permission to run billable tests`);
            }

      - name: Get PR ref
        id: get-ref
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.head.sha);

  billable-debug-examples:
    name: Billable Tests / Debug Examples
    needs: billable-permission-check
    if: needs.billable-permission-check.outputs.has_permission == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}
        ref: ${{ needs.billable-permission-check.outputs.ref }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/debug-examples

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export AO_DB_PATH="$HOME/.cache/ao/tests/debug-examples"
        export PYTHON_PORT=5960
        source $HOME/miniconda/bin/activate ao
        ao-server start

    - name: Run tests
      env:
        AO_DB_PATH: ~/.cache/ao/tests/debug-examples
        PYTHON_PORT: 5960
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate ao
        pytest -v -s tests/billable/test_debug_examples.py

    - name: Clean up
      if: always()
      run: rm -rf ~/.cache/ao/tests/debug-examples

  billable-caching-edit:
    name: Billable Tests / Caching Edit
    needs: billable-permission-check
    if: needs.billable-permission-check.outputs.has_permission == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}
        ref: ${{ needs.billable-permission-check.outputs.ref }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/caching-edit

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export AO_DB_PATH="$HOME/.cache/ao/tests/caching-edit"
        export PYTHON_PORT=5962
        source $HOME/miniconda/bin/activate ao
        ao-server start

    - name: Run tests
      env:
        AO_DB_PATH: ~/.cache/ao/tests/caching-edit
        PYTHON_PORT: 5962
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate ao
        pytest -v -s tests/billable/test_caching_edit.py

    - name: Clean up
      if: always()
      run: rm -rf ~/.cache/ao/tests/caching-edit

  billable-status:
    name: Billable Tests / Status
    needs: [billable-permission-check, billable-debug-examples, billable-caching-edit]
    if: always() && needs.billable-permission-check.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Report status
        uses: actions/github-script@v7
        with:
          script: |
            const debugResult = '${{ needs.billable-debug-examples.result }}';
            const cachingResult = '${{ needs.billable-caching-edit.result }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const allPassed = debugResult === 'success' && cachingResult === 'success';
            const reaction = allPassed ? 'rocket' : '-1';
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: reaction
            });
            
            const status = allPassed 
              ? `✅ All billable tests passed! [View logs](${runUrl})`
              : `❌ Billable tests failed ([View logs](${runUrl})):\n- Debug Examples: ${debugResult}\n- Caching Edit: ${cachingResult}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: status
            });