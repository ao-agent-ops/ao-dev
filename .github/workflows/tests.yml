name: Pytest

on:
  push:
  workflow_dispatch:

jobs:
  test-non-billable:
    name: Non-Billable Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/non-billable

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export AO_DB_PATH="$HOME/.cache/ao/tests/non-billable"
        export PYTHON_PORT=5959
        source $HOME/miniconda/bin/activate ao
        ao-server start

    - name: Test with pytest (non-billable tests)
      env:
        AO_DB_PATH: ~/.cache/ao/tests/non-billable
        PYTHON_PORT: 5959
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate ao
        pytest -v -s tests/non_billable/

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/ao/tests/non-billable

  test-debug-examples:
    name: Debug Examples Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Debug - Check file contents
      run: |
        echo "=== Git commit ==="
        git log -1 --oneline
        echo ""
        echo "=== src/__init__.py ==="
        cat -n src/__init__.py
        echo ""
        echo "=== src/server/__init__.py ==="
        cat -n src/server/__init__.py || echo "File is empty or does not exist"
        wc -c src/server/__init__.py
        echo ""
        echo "=== src/server/ast_helpers.py (first 20 lines) ==="
        head -20 src/server/ast_helpers.py
        echo ""
        echo "=== src/server/ast_transformer.py (first 20 lines) ==="
        head -20 src/server/ast_transformer.py
        echo ""
        echo "=== Check for __pycache__ ==="
        find . -name "__pycache__" -type d | head -10

    - name: Debug - Test import chain
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate ao
        echo "=== Testing import of ao package ==="
        python -c "import sys; print('Python version', sys.version); import ao; print('SUCCESS')" || python -c "import traceback; traceback.print_exc()"
        echo ""
        echo "=== Testing ao-server command ==="
        which ao-server
        echo "--- ao-server script content ---"
        cat $(which ao-server)
        echo ""
        echo "--- Testing ao-server directly ---"
        ao-server --help || echo "ao-server --help failed with exit code $?"
        echo ""
        echo "=== Testing import of ao.cli.ao_server ==="
        python -c "from ao.cli.ao_server import main; print('SUCCESS')" || echo "FAILED"

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/debug-examples

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export AO_DB_PATH="$HOME/.cache/ao/tests/debug-examples"
        export PYTHON_PORT=5960
        source $HOME/miniconda/bin/activate ao
        ao-server start

    - name: Test debug examples with pytest
      env:
        AO_DB_PATH: ~/.cache/ao/tests/debug-examples
        PYTHON_PORT: 5960
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate ao
        pytest -v -s tests/billable/test_debug_examples.py

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/ao/tests/debug-examples

  test-caching-edit:
    name: Caching Edit Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/caching-edit

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export AO_DB_PATH="$HOME/.cache/ao/tests/caching-edit"
        export PYTHON_PORT=5962
        source $HOME/miniconda/bin/activate ao
        ao-server start

    - name: Test caching edit with pytest
      env:
        AO_DB_PATH: ~/.cache/ao/tests/caching-edit
        PYTHON_PORT: 5962
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate ao
        pytest -v -s tests/billable/test_caching_edit.py

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/ao/tests/caching-edit
