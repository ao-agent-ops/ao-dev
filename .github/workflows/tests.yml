name: Pytest

on: [push]

jobs:
  test-non-billable:
    name: Non-Billable Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/agent-copilot/tests/non-billable

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export ACO_DB_PATH="$HOME/.cache/agent-copilot/tests/non-billable"
        export PYTHON_PORT=5959
        source $HOME/miniconda/bin/activate aco
        aco-server start

    - name: Test with pytest (non-billable tests)
      env:
        ACO_DB_PATH: ~/.cache/agent-copilot/tests/non-billable
        PYTHON_PORT: 5959
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        pytest -v -s tests/non_billable/

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/agent-copilot/tests/non-billable

  test-debug-examples:
    name: Debug Examples Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/agent-copilot/tests/debug-examples

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export ACO_DB_PATH="$HOME/.cache/agent-copilot/tests/debug-examples"
        export PYTHON_PORT=5960
        source $HOME/miniconda/bin/activate aco
        aco-server start

    - name: Test debug examples with pytest
      env:
        ACO_DB_PATH: ~/.cache/agent-copilot/tests/debug-examples
        PYTHON_PORT: 5960
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        pytest -v -s tests/billable/test_debug_examples.py

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/agent-copilot/tests/debug-examples

  test-caching-edit:
    name: Caching Edit Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/agent-copilot/tests/caching-edit

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export ACO_DB_PATH="$HOME/.cache/agent-copilot/tests/caching-edit"
        export PYTHON_PORT=5962
        source $HOME/miniconda/bin/activate aco
        aco-server start

    - name: Test caching edit with pytest
      env:
        ACO_DB_PATH: ~/.cache/agent-copilot/tests/caching-edit
        PYTHON_PORT: 5962
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        pytest -v -s tests/billable/test_caching_edit.py

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/agent-copilot/tests/caching-edit
