name: Pytest

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Download and install Miniconda
      run: |
        # Check if we're running in act (local testing)
        if [ -n "$ACT" ]; then
          echo "Running in act (local environment)"
        fi
        
        # Detect system architecture and OS
        ARCH=$(uname -m)
        OS=$(uname -s)
        echo "Detected OS: $OS, Architecture: $ARCH"
        
        # Determine the correct Miniconda download URL
        if [[ "$OS" == "Linux" ]]; then
          if [[ "$ARCH" == "x86_64" ]]; then
            MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh"
          elif [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]]; then
            MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh"
          else
            echo "Unsupported Linux architecture: $ARCH"
            exit 1
          fi
        elif [[ "$OS" == "Darwin" ]]; then
          if [[ "$ARCH" == "x86_64" ]]; then
            MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh"
          elif [[ "$ARCH" == "arm64" ]]; then
            MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-arm64.sh"
          else
            echo "Unsupported macOS architecture: $ARCH"
            exit 1
          fi
        else
          echo "Unsupported OS: $OS"
          exit 1
        fi
        
        echo "Downloading Miniconda from: $MINICONDA_URL"
        curl -sSL "$MINICONDA_URL" -o miniconda.sh
        
        # Install Miniconda
        bash miniconda.sh -b -p $HOME/miniconda
        
        # Initialize conda
        source $HOME/miniconda/bin/activate
        conda init bash
        
        # Add to PATH for current and future steps
        echo "$HOME/miniconda/bin" >> $GITHUB_PATH
        export PATH="$HOME/miniconda/bin:$PATH"
        
        # Verify installation
        conda --version

    - name: Create conda environment
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        conda create -n aco python=3.13 -y
        conda info --envs

    - name: Install dev dependencies for testing
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        
        which python
        which pip
        
        pip install -e ".[dev]"

    - name: Lint with flake8
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        
        pip install flake8
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Setup MiroFlow dependencies
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        
        # Install MiroFlow packages (submodules already initialized by checkout)
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow-contrib
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow-tool
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        
        aco-server start

    - name: Test with pytest
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        pytest --capture=tee-sys tests/

    - name: Clean up shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        
        aco-server stop
