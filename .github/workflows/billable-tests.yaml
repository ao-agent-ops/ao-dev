name: Billable Tests

on:
  issue_comment:
    types: [created]
  workflow_dispatch:  # Manual trigger (requires write access)

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  permission-check:
    name: Permission Check
    # Only run for issue_comment trigger
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/run-billable-tests')
    runs-on: ubuntu-latest
    outputs:
      has_permission: ${{ steps.check.outputs.has_permission }}
      ref: ${{ steps.get-ref.outputs.ref }}
    steps:
      - name: Add eyes reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Check permissions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            const hasPermission = ['admin', 'write'].includes(permission.permission);
            core.setOutput('has_permission', hasPermission);

            if (!hasPermission) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: '-1'
              });
              core.setFailed(`User ${context.actor} does not have permission to run billable tests`);
            }

      - name: Get PR ref
        id: get-ref
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.head.sha);

  edits:
    name: Edits
    needs: permission-check
    # Run if permission-check passed OR if this is a workflow_dispatch (permission-check is skipped)
    if: |
      always() &&
      ((needs.permission-check.result == 'success' && needs.permission-check.outputs.has_permission == 'true') ||
       (github.event_name == 'workflow_dispatch' && needs.permission-check.result == 'skipped'))
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}
        ref: ${{ needs.permission-check.outputs.ref || github.sha }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/caching-edit

    - name: Launch ao server
      run: |
        export DB_PATH="$HOME/.cache/ao/tests/caching-edit"
        export PYTHON_PORT=5962
        uv run ao-server start

    - name: Run tests
      env:
        DB_PATH: ~/.cache/ao/tests/caching-edit
        PYTHON_PORT: 5962
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        uv run pytest -v -s tests/billable/test_edits.py

    - name: Clean up
      if: always()
      run: rm -rf ~/.cache/ao/tests/caching-edit

  caching:
    name: Caching
    needs: permission-check
    # Run if permission-check passed OR if this is a workflow_dispatch (permission-check is skipped)
    if: |
      always() &&
      ((needs.permission-check.result == 'success' && needs.permission-check.outputs.has_permission == 'true') ||
       (github.event_name == 'workflow_dispatch' && needs.permission-check.result == 'skipped'))
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}
        ref: ${{ needs.permission-check.outputs.ref || github.sha }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/ao/tests/caching

    - name: Launch ao server
      run: |
        export DB_PATH="$HOME/.cache/ao/tests/caching"
        export PYTHON_PORT=5963
        uv run ao-server start

    - name: Run tests
      env:
        DB_PATH: ~/.cache/ao/tests/caching
        PYTHON_PORT: 5963
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        uv run pytest -v -s tests/billable/test_caching.py

    - name: Clean up
      if: always()
      run: rm -rf ~/.cache/ao/tests/caching

  status:
    name: Status
    needs: [permission-check, edits, caching]
    # Only post status for issue_comment trigger (not workflow_dispatch)
    if: always() && github.event_name == 'issue_comment' && needs.permission-check.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Report status
        uses: actions/github-script@v7
        with:
          script: |
            const editsResult = '${{ needs.edits.result }}';
            const cachingResult = '${{ needs.caching.result }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const allPassed = editsResult === 'success' && cachingResult === 'success';
            const reaction = allPassed ? 'rocket' : '-1';

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: reaction
            });

            const status = allPassed
              ? `✅ All billable tests passed! [View logs](${runUrl})`
              : `❌ Billable tests failed ([View logs](${runUrl})):\n- Edits: ${editsResult}\n- Caching: ${cachingResult}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: status
            });
