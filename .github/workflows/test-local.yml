name: Test Local (Non-Billable)

on: [push]

jobs:
  test-general:
    name: General Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/agent-copilot/tests/general

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export ACO_DB_PATH="$HOME/.cache/agent-copilot/tests/general"
        export PYTHON_PORT=5959
        source $HOME/miniconda/bin/activate aco
        aco-server start

    - name: Test with pytest (excluding deep research)
      env:
        ACO_DB_PATH: ~/.cache/agent-copilot/tests/general
        PYTHON_PORT: 5959
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        # Run all tests except test_deepresearch
        pytest -v -s tests/ -k "not test_deepresearch"

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/agent-copilot/tests/general

  test-deep-research:
    name: Deep Research Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup isolated test database
      run: mkdir -p ~/.cache/agent-copilot/tests/deep-research

    - name: Setup MiroFlow dependencies
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco

        # Install MiroFlow packages (submodules already initialized by checkout)
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow-contrib
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow-tool
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow

    - name: Launch shim server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        export ACO_DB_PATH="$HOME/.cache/agent-copilot/tests/deep-research"
        export PYTHON_PORT=5960
        source $HOME/miniconda/bin/activate aco
        aco-server start

    - name: Test with pytest (local tests only)
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        pytest -v -s tests/local/

    - name: Print server log
      if: always()
      run: cat ~/.cache/agent-copilot/tests/deep-research/server.log

    - name: Clean up test database
      if: always()
      run: rm -rf ~/.cache/agent-copilot/tests/deep-research
