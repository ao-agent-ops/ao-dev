name: Test Deep Research (Admin Only)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running deep research test'
        required: true
        type: string

jobs:
  test-deepresearch:
    runs-on: ubuntu-latest
    environment:
      name: billable-tests  # Requires admin approval

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup test environment
      uses: ./.github/actions/setup-test-environment

    - name: Setup MiroFlow dependencies
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco

        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow-contrib
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow-tool
        pip install -e example_workflows/miroflow_deep_research/MiroFlow/libs/miroflow

    - name: Launch server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        aco-server start

    - name: Run deep research test
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco

        echo "Running deep research test..."
        echo "Trigger reason: ${{ github.event.inputs.reason }}"

        pytest -v -s tests/billable/test_deepresearch.py

    - name: Clean up server
      run: |
        export PATH="$HOME/miniconda/bin:$PATH"
        source $HOME/miniconda/bin/activate aco
        aco-server stop