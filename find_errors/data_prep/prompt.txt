I'm translating code from a high-level decsription into runnable python code using LLMs. I take several steps to do this, and my final code is wrong. I want to figure out which was the first step that was to unclear or incorrect, such that the later steps couldn't recover from that failure. Erros could include describing a wrong design, being to inconcise, or simply not producing the right code although the previously described approach is perfectly clear. Be critical in your analysis of every step and consider each step as a possible root cause for the final error (i.e., even steps that don't produce code may be inconcise and therefore result in the wrong code). The code is part of a larger code base. The high-level task description describes functionality and what dependencies to use (e.g., dependencies inside the repo and extermal packages).

1. First, I'm doing an aanlysis of the high-level text. This produces a difficulty rating and XXX.
2. Second, I'm planning the implementation in several iterations. This produces high-level code that becomes more and more concrete.
3. I'm generating the actual source code. I will give you the code here and a review that the LLM gets on the generated code.

Below are all the step's:

---------------------------------------------
Step 1: Analyzing the high-level task description:

# Difficulty Analysis
This file is of **medium** complexity. The Routes class contains numerous methods for handling different HTTP routes, but most of them follow a similar pattern:
1. Extract data from request
2. Call appropriate service method
3. Redirect or render template

While there are many methods, they're mostly straightforward and follow consistent patterns. The complexity comes from the sheer number of routes and ensuring proper authentication and error handling across all of them.

# Dependency Analysis
The file depends on:
- Flask framework (Flask, request, session, redirect, url_for, render_template, flash, jsonify)
- Backend services (AgentService, AdminAgentService)
- Database components (Schema, PostgresOperations)
- Data models (Agent, CompanyNote, Company, Contact, ContactNote, Task, EmailTemplate)
- Logging

All these dependencies are necessary for implementing the routes. The file acts as a controller layer connecting the frontend (templates) with the backend services.

## Missing Dependencies
No missing dependencies identified. All necessary imports are present.

## Irrelevant Dependencies
No irrelevant dependencies identified. All imports are used in the implementation.

# Implementation Approach
1. **Initialize the Routes class**: Implement the constructor to store references to the Flask app and services.

2. **Implement register_routes method**: Map all URL patterns to their respective handler methods using Flask's route decorators.

3. **Implement authentication routes**: Login, logout, and session management.

4. **Implement CRUD operations for each entity**:
   - Companies (list, view, add, update, delete)
   - Company notes (add, edit, delete)
   - Contacts (list, view, add, update, delete)
   - Contact notes (add, edit, delete)
   - Tasks (list, view, add, update, delete, mark complete)
   - Email functionality
   - Settings

5. **Implement admin-specific routes**: Agent management (list, view, edit, delete, create)

6. **Add error handling and authentication checks**: Ensure users are logged in before accessing protected routes.

## Dedicated Implementations
No dedicated implementations needed. While there are many methods, they follow similar patterns and can be implemented together.

---------------------------------------------
Step 2: Iteratively planning the implementation:

Produced plan (iteratively refined Python code):

class Routes:
    '''
    This class defines all the route handlers for the CRM application.
    It handles routing for all pages including login, home, companies, contacts, tasks, email, settings, and admin pages.
    '''

    def __init__(self,
                 app: Flask,
                 agent_service: AgentService,
                 admin_service: t.Optional[AdminAgentService]=None,
                 ):
        '''
        Initialize the Routes class with the Flask app and all required services.

        Parameters:
        - app: The Flask application instance
        - agent_service: Services for an agent
        - admin_agent_service: Services for an admin agent (who can do whatever an agent can do and add/remove agent)
        '''
        self.app = app
        self.agent_service = agent_service
        self.admin_agent_service = admin_service
        self.service = self.agent_service
        self.register_routes()

    def register_routes(self) -> None:
        '''
        Register all route handlers with the Flask application.
        This method sets up all the URL routes and connects them to their respective handler methods, defined below
        '''
        # Basic routes
        self.app.route('/')(self.home)
        self.app.route('/login', methods=['GET', 'POST'])(self.login)
        self.app.route('/logout')(self.logout)
        self.app.route('/agent/home')(self.agent_home)
        
        # Company routes
        self.app.route('/companies')(self.companies_list)
        self.app.route('/companies/add', methods=['POST'])(self.add_company)
        self.app.route('/companies/<int:company_id>')(self.company_view)
        self.app.route('/companies/update', methods=['POST'])(self.update_company)
        self.app.route('/companies/update_many', methods=['POST'])(self.update_companies)
        self.app.route('/companies/remove', methods=['POST'])(self.remove_company)
        
        # Company notes routes
        self.app.route('/companies/<int:company_id>/notes/add', methods=['POST'])(self.add_company_note)
        self.app.route('/companies/<int:company_id>/notes/edit', methods=['POST'])(self.company_note_edit)
        self.app.route('/companies/<int:company_id>/notes/remove', methods=['POST'])(self.remove_company_note)
        
        # Contact routes
        self.app.route('/contacts')(self.contacts_list)
        self.app.route('/contacts/<int:contact_id>')(self.contact_view)
        self.app.route('/contacts/add', methods=['POST'])(self.add_contact)
        self.app.route('/contacts/update', methods=['POST'])(self.update_contact)
        self.app.route('/contacts/remove', methods=['POST'])(self.remove_contact)
        
        # Contact notes routes
        self.app.route('/contacts/<int:contact_id>/notes/add', methods=['POST'])(self.add_contact_note)
        self.app.route('/contacts/<int:contact_id>/notes/edit', methods=['POST'])(self.contact_note_edit)
        self.app.route('/contacts/<int:contact_id>/notes/remove', methods=['POST'])(self.remove_contact_note)
        
        # Task routes
        self.app.route('/tasks')(self.tasks_list)
        self.app.route('/tasks/<int:task_id>')(self.task_view)
        self.app.route('/tasks/add', methods=['POST'])(self.add_task)
        self.app.route('/tasks/<int:task_id>/edit', methods=['POST'])(self.task_edit)
        self.app.route('/tasks/remove', methods=['POST'])(self.remove_task)
        self.app.route('/tasks/complete', methods=['POST'])(self.mark_task_as_complete)
        
        # Email routes
        self.app.route('/email/send', methods=['POST'])(self.send_email)
        
        # Settings routes
        self.app.route('/settings')(self.settings)
        
        # Admin routes
        self.app.route('/admin/agents')(self.agents_list)
        self.app.route('/admin/agents/<int:agent_id>')(self.agent_view)
        self.app.route('/admin/agents/edit', methods=['POST'])(self.agent_edit)
        self.app.route('/admin/agents/<int:agent_id>/delete', methods=['POST'])(self.agent_delete)
        self.app.route('/admin/agents/new', methods=['POST'])(self.agent_new)

    def home(self):
        '''
        The home for the Flask application. Redirects to login
        '''
        return redirect(url_for('login'))

    def login(self):
        '''
        Handle user login for both agents and admins.

        GET: Display the login form
        POST: Process the login form submission

        If login is successful, redirect to the agent_home or admin_home page accordingly.
        If login fails, show an error message and redisplay the login form.

        Uses AgentService.login or AdminService.login to verify credentials.
        '''
        if request.method == 'GET':
            return render_template('login.html')
        
        # Process login form
        agent_id = request.form.get('agent_id', '')
        agent_email = request.form.get('agent_email', '')
        password = request.form.get('password', '')
        is_admin = request.form.get('is_admin', False)
        
        # Try to login
        if is_admin and self.admin_agent_service:
            login_success = self.admin_agent_service.login(
                agent_id=int(agent_id) if agent_id.isdigit() else -1,
                agent_email=agent_email,
                password=password
            )
            if login_success:
                session['logged_in'] = True
                session['is_admin'] = True
                session['agent_id'] = self.admin_agent_service.agent_id
                self.service = self.admin_agent_service
                flash('Admin login successful!', 'success')
                return redirect(url_for('agent_home'))
        else:
            login_success = self.agent_service.login(
                agent_id=int(agent_id) if agent_id.isdigit() else -1,
                agent_email=agent_email,
                password=password
            )
            if login_success:
                session['logged_in'] = True
                session['is_admin'] = False
                session['agent_id'] = self.agent_service.agent_id
                self.service = self.agent_service
                flash('Login successful!', 'success')
                return redirect(url_for('agent_home'))
        
        # Login failed
        flash('Invalid credentials. Please try again.', 'error')
        return render_template('login.html')

    def logout(self):
        '''
        Handle user logout.
        Clear the user session and redirect to the login page.
        '''
        if self.service:
            self.service.logout()
        
        session.clear()
        self.service = self.agent_service
        flash('You have been logged out.', 'info')
        return redirect(url_for('login'))

    def agent_home(self):
        '''
        Display the home/start page of the agent. Render agent_home.html
        On top of this page, show a dashboard with
        - Home: return to this page.
        - Companies: go to companies_list
        - Contacts: go to contacts_list
        - Tasks: go to tasks_list
        - Email: go to email_page
        - Settings: go to settings_list
        '''
        if not session.get('logged_in'):
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        return render_template('agent_home.html', 
                              agent=self.service.agent,
                              is_admin=session.get('is_admin', False))

Performed steps:

# Performed Steps
I've analyzed the file structure and requirements for the `app.routes` module. This file defines a `Routes` class that handles all HTTP routes for a CRM application, connecting Flask URL endpoints to view functions that interact with the backend services.

The file requires implementation of:
1. Constructor to initialize the Routes class with Flask app and services
2. Route registration method to map URLs to handler functions
3. Various route handler methods for different CRM functionalities

## Partial Completions
None yet - starting fresh

## Updates of Previously Completed Nodes
None yet - starting fresh

## Full Completions
None yet - starting fresh

## Untouched Nodes
All nodes are currently untouched as this is the first iteration.

# Next Steps
I'll start by implementing:
1. The constructor (`__init__`) to store references to the Flask app and services
2. The `register_routes` method to map all URL patterns to their respective handler methods
3. Basic authentication routes (login, logout, home)

## Next to Plan
- `__init__` method
- `register_routes` method
- `home` method
- `login` method
- `logout` method
- `agent_home` method

## New Helpers and Variables
No new helpers or variables needed at this stage.

## Updates to Existing Helpers and Variables
None needed at this stage.

## Missing Dependencies
None identified at this stage.

## Irrelevant Dependencies
None identified at this stage.

## Difficulty
Easy - The initial methods are straightforward to implement as they primarily involve setting up the Flask routes and basic authentication.


---------------------------------------------
Step 3: Iteratively planning the implementation:

Produced plan (iteratively refined Python code):

class Routes:
    '''Class that handles all HTTP routes for the CRM application'''

    def __init__(self, app: Flask, agent_service: AgentService, admin_service: AdminAgentService):
        '''Initialize the Routes class with Flask app and services'''
        self.app = app
        self.agent_service = agent_service
        self.admin_service = admin_service

    def register_routes(self):
        '''Register all routes with the Flask app'''
        # Home and authentication routes
        self.app.route('/')(self.home)
        self.app.route('/login', methods=['GET', 'POST'])(self.login)
        self.app.route('/logout')(self.logout)
        self.app.route('/agent_home')(self.agent_home)
        
        # Company routes
        self.app.route('/companies')(self.companies_list)
        self.app.route('/companies/add', methods=['GET', 'POST'])(self.add_company)
        self.app.route('/companies/<int:company_id>')(self.company_view)
        self.app.route('/companies/update', methods=['POST'])(self.update_companies)
        self.app.route('/companies/<int:company_id>/update', methods=['POST'])(self.update_company)
        self.app.route('/companies/<int:company_id>/remove')(self.remove_company)
        
        # Company notes routes
        self.app.route('/companies/<int:company_id>/notes/<int:note_id>/edit', methods=['POST'])(self.company_note_edit)
        self.app.route('/companies/<int:company_id>/notes/<int:note_id>/remove')(self.remove_company_note)
        self.app.route('/companies/<int:company_id>/notes/add', methods=['POST'])(self.add_company_note)
        
        # Contact routes
        self.app.route('/contacts')(self.contacts_list)
        self.app.route('/contacts/<int:contact_id>')(self.contact_view)
        self.app.route('/contacts/<int:contact_id>/update', methods=['POST'])(self.update_contact)
        self.app.route('/contacts/<int:contact_id>/remove')(self.remove_contact)
        self.app.route('/contacts/add', methods=['GET', 'POST'])(self.add_contact)
        
        # Contact notes routes
        self.app.route('/contacts/<int:contact_id>/notes/<int:note_id>/edit', methods=['POST'])(self.contact_note_edit)
        self.app.route('/contacts/<int:contact_id>/notes/<int:note_id>/remove')(self.remove_contact_note)
        self.app.route('/contacts/<int:contact_id>/notes/add', methods=['POST'])(self.add_contact_note)
        
        # Task routes
        self.app.route('/tasks')(self.tasks_list)
        self.app.route('/tasks/<int:task_id>')(self.task_view)
        self.app.route('/tasks/<int:task_id>/edit', methods=['POST'])(self.task_edit)
        self.app.route('/tasks/<int:task_id>/remove')(self.remove_task)
        self.app.route('/tasks/<int:task_id>/complete', methods=['POST'])(self.mark_task_as_complete)
        self.app.route('/tasks/add', methods=['GET', 'POST'])(self.add_task)
        
        # Email routes
        self.app.route('/contacts/<int:contact_id>/send_email', methods=['GET', 'POST'])(self.send_email)
        
        # Settings routes
        self.app.route('/settings')(self.settings)
        
        # Admin routes
        self.app.route('/agents')(self.agents_list)
        self.app.route('/agents/<int:agent_id>')(self.agent_view)
        self.app.route('/agents/<int:agent_id>/edit', methods=['POST'])(self.agent_edit)
        self.app.route('/agents/<int:agent_id>/delete')(self.agent_delete)
        self.app.route('/agents/new', methods=['GET', 'POST'])(self.agent_new)

    def home(self):
        '''Render the home page or redirect to login if not authenticated'''
        if 'agent_id' not in session:
            return redirect(url_for('login'))
        return redirect(url_for('agent_home'))

    def login(self):
        '''Handle agent login'''
        if request.method == 'POST':
            agent_id = request.form.get('agent_id', None)
            agent_email = request.form.get('agent_email', None)
            password = request.form.get('password', '')
            
            # Try admin login first
            if self.admin_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.admin_service.agent_id
                session['is_admin'] = True
                flash('Admin login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            # Try regular agent login
            if self.agent_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.agent_service.agent_id
                session['is_admin'] = False
                flash('Login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            flash('Invalid credentials. Please try again.', 'error')
        
        return render_template('login.html')

    def logout(self):
        '''Handle agent logout'''
        if 'is_admin' in session and session['is_admin']:
            self.admin_service.logout()
        else:
            self.agent_service.logout()
        
        session.clear()
        flash('You have been logged out.', 'info')
        return redirect(url_for('login'))

    def agent_home(self):
        '''Render the agent home page'''
        if 'agent_id' not in session:
            return redirect(url_for('login'))
        
        service = self.admin_service if session.get('is_admin', False) else self.agent_service
        agent = service.show_setting()
        
        return render_template('agent_home.html', agent=agent, is_admin=session.get('is_admin', False))

Performed steps:

# Performed Steps
I've analyzed the file structure and requirements for the `app.routes` module. This file needs to define a `Routes` class that handles all HTTP routes for a CRM application, connecting Flask URL endpoints to view functions that interact with the backend services.

I'll start by implementing:
1. The constructor (`__init__`) to store references to the Flask app and services
2. The `register_routes` method to map all URL patterns to their respective handler methods
3. Basic authentication routes (login, logout, home)

## Partial Completions
None yet - starting fresh

## Updates of Previously Completed Nodes
None yet - starting fresh

## Full Completions
None yet - starting fresh

## Untouched Nodes
All nodes are currently untouched as this is the first iteration.

# Next Steps
I'll implement the basic structure of the Routes class including:
1. The constructor (`__init__`) to store references to the Flask app and services
2. The `register_routes` method to map all URL patterns to their respective handler methods
3. Basic authentication routes (login, logout, home)

## Next to Plan
- `__init__` method
- `register_routes` method
- `home` method
- `login` method
- `logout` method
- `agent_home` method

## New Helpers and Variables
No new helpers or variables needed at this stage.

## Updates to Existing Helpers and Variables
None needed at this stage.

## Missing Dependencies
None identified at this stage.

## Irrelevant Dependencies
None identified at this stage.

## Difficulty
Easy - The initial methods are straightforward to implement as they primarily involve setting up the Flask routes and basic authentication.


---------------------------------------------
Step 4: Iteratively planning the implementation:

Produced plan (iteratively refined Python code):

class Routes:
    '''Class that defines all routes for the Flask application'''

    def __init__(self, app: Flask, agent_service: AgentService, admin_service: AdminAgentService):
        '''Initialize the Routes class with the Flask app and services'''
        self.app = app
        self.agent_service = agent_service
        self.admin_service = admin_service
        self.register_routes()

    def register_routes(self):
        '''Register all routes with the Flask app'''
        # Authentication routes
        self.app.route('/')(self.home)
        self.app.route('/login', methods=['GET', 'POST'])(self.login)
        self.app.route('/logout')(self.logout)
        
        # Agent home
        self.app.route('/agent/home')(self.agent_home)
        
        # Company routes
        self.app.route('/companies')(self.companies_list)
        self.app.route('/companies/add', methods=['GET', 'POST'])(self.add_company)
        self.app.route('/companies/<int:company_id>')(self.company_view)
        self.app.route('/companies/<int:company_id>/update', methods=['GET', 'POST'])(self.update_company)
        self.app.route('/companies/<int:company_id>/delete')(self.remove_company)
        
        # Company notes routes
        self.app.route('/companies/<int:company_id>/notes/add', methods=['POST'])(self.add_company_note)
        self.app.route('/companies/<int:company_id>/notes/<int:note_id>/edit', methods=['POST'])(self.company_note_edit)
        self.app.route('/companies/<int:company_id>/notes/<int:note_id>/delete')(self.remove_company_note)
        
        # Contact routes
        self.app.route('/contacts')(self.contacts_list)
        self.app.route('/contacts/<int:contact_id>')(self.contact_view)
        self.app.route('/contacts/<int:contact_id>/update', methods=['GET', 'POST'])(self.update_contact)
        self.app.route('/contacts/<int:contact_id>/delete')(self.remove_contact)
        self.app.route('/contacts/add', methods=['GET', 'POST'])(self.add_contact)
        
        # Contact notes routes
        self.app.route('/contacts/<int:contact_id>/notes/add', methods=['POST'])(self.add_contact_note)
        self.app.route('/contacts/<int:contact_id>/notes/<int:note_id>/edit', methods=['POST'])(self.contact_note_edit)
        self.app.route('/contacts/<int:contact_id>/notes/<int:note_id>/delete')(self.remove_contact_note)
        
        # Task routes
        self.app.route('/tasks')(self.tasks_list)
        self.app.route('/tasks/<int:task_id>')(self.task_view)
        self.app.route('/tasks/<int:task_id>/edit', methods=['GET', 'POST'])(self.task_edit)
        self.app.route('/tasks/<int:task_id>/delete')(self.remove_task)
        self.app.route('/tasks/<int:task_id>/complete')(self.mark_task_as_complete)
        self.app.route('/tasks/add', methods=['GET', 'POST'])(self.add_task)
        
        # Email routes
        self.app.route('/contacts/<int:contact_id>/send-email', methods=['GET', 'POST'])(self.send_email)
        
        # Settings routes
        self.app.route('/settings')(self.settings)
        
        # Admin routes
        self.app.route('/admin/agents')(self.agents_list)
        self.app.route('/admin/agents/<int:agent_id>')(self.agent_view)
        self.app.route('/admin/agents/<int:agent_id>/edit', methods=['GET', 'POST'])(self.agent_edit)
        self.app.route('/admin/agents/<int:agent_id>/delete')(self.agent_delete)
        self.app.route('/admin/agents/new', methods=['GET', 'POST'])(self.agent_new)

    def home(self):
        '''Render the home page or redirect to agent home if logged in'''
        if 'agent_id' in session:
            return redirect(url_for('agent_home'))
        return render_template('home.html')

    def login(self):
        '''Handle agent login'''
        if request.method == 'POST':
            agent_id = request.form.get('agent_id', type=int)
            agent_email = request.form.get('agent_email', '')
            password = request.form.get('password', '')
            
            # Try admin login first
            if self.admin_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.admin_service.agent_id
                session['is_admin'] = True
                flash('Admin login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            # Try regular agent login
            if self.agent_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.agent_service.agent_id
                session['is_admin'] = False
                flash('Login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            flash('Invalid credentials. Please try again.', 'error')
        
        return render_template('login.html')

    def logout(self):
        '''Handle agent logout'''
        if 'is_admin' in session and session['is_admin']:
            self.admin_service.logout()
        else:
            self.agent_service.logout()
        
        session.clear()
        flash('You have been logged out.', 'info')
        return redirect(url_for('home'))

    def agent_home(self):
        '''Render the agent home page'''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        service = self.admin_service if session.get('is_admin', False) else self.agent_service
        agent = service.show_setting()
        
        return render_template('agent_home.html', agent=agent)

Performed steps:

# Performed Steps
I've analyzed the file structure and requirements for the `app.routes` module. This file needs to define a `Routes` class that handles all HTTP routes for a CRM application, connecting Flask URL endpoints to view functions that interact with the backend services.

I'll start by implementing:
1. The constructor (`__init__`) to store references to the Flask app and services
2. The `register_routes` method to map all URL patterns to their respective handler methods
3. Basic authentication routes (login, logout, home)

## Partial Completions
None yet - starting fresh

## Updates of Previously Completed Nodes
None yet - starting fresh

## Full Completions
None yet - starting fresh

## Untouched Nodes
All nodes are currently untouched as this is the first iteration.

# Next Steps
I'll implement the basic structure of the Routes class including:
1. The constructor (`__init__`) to store references to the Flask app and services
2. The `register_routes` method to map all URL patterns to their respective handler methods
3. Basic authentication routes (login, logout, home)

## Next to Plan
- `__init__` method
- `register_routes` method
- `home` method
- `login` method
- `logout` method
- `agent_home` method

## New Helpers and Variables
No new helpers or variables needed at this stage.

## Updates to Existing Helpers and Variables
None needed at this stage.

## Missing Dependencies
None identified at this stage.

## Irrelevant Dependencies
None identified at this stage.

## Difficulty
Easy - The initial methods are straightforward to implement as they primarily involve setting up the Flask routes and basic authentication.


---------------------------------------------
Step 5: Implementing the actual code (implementation and review):

Implemmentation:

"""Defines all routes for the Flask application, mapping URLs to view functions"""

import typing as t
from datetime import datetime
from flask import Flask, request, session, redirect, url_for, render_template, flash, jsonify
from backend_services.agent_service import AgentService
from backend_services.admin_service import AdminAgentService
from database.schema import Schema
from backend_services.data_models import Agent, CompanyNote, Company, Contact, ContactNote, Task, EmailTemplate
from database.db_operations import PostgresOperations
import logging

logger = logging.getLogger(__name__)


class Routes:
    '''
    This class defines all the route handlers for the CRM application.
    It handles routing for all pages including login, home, companies, contacts, tasks, email, settings, and admin pages.
    '''

    def __init__(self,
                 app: Flask,
                 agent_service: AgentService,
                 admin_service: t.Optional[AdminAgentService]=None,
                 ):
        '''
        Initialize the Routes class with the Flask app and all required services.

        Parameters:
        - app: The Flask application instance
        - agent_service: Services for an agent
        - admin_agent_service: Services for an admin agent (who can do whatever an agent can do and add/remove agent)
        '''
        self.app = app
        self.agent_service = agent_service
        self.admin_service = admin_service
        self.service = self.agent_service
        self.register_routes()

    def register_routes(self) -> None:
        '''
        Register all route handlers with the Flask application.
        This method sets up all the URL routes and connects them to their respective handler methods, defined below
        '''
        # Authentication routes
        self.app.route('/')(self.home)
        self.app.route('/login', methods=['GET', 'POST'])(self.login)
        self.app.route('/logout')(self.logout)
        
        # Agent home
        self.app.route('/agent/home')(self.agent_home)
        
        # Company routes
        self.app.route('/companies')(self.companies_list)
        self.app.route('/companies/add', methods=['POST'])(self.add_company)
        self.app.route('/companies/<int:company_id>')(self.company_view)
        self.app.route('/companies/update', methods=['POST'])(self.update_companies)
        self.app.route('/company/update', methods=['POST'])(self.update_company)
        self.app.route('/company/remove', methods=['POST'])(self.remove_company)
        
        # Company notes routes
        self.app.route('/companies/<int:company_id>/notes/add', methods=['POST'])(self.add_company_note)
        self.app.route('/companies/<int:company_id>/notes/edit', methods=['POST'])(self.company_note_edit)
        self.app.route('/companies/<int:company_id>/notes/remove', methods=['POST'])(self.remove_company_note)
        
        # Contact routes
        self.app.route('/contacts')(self.contacts_list)
        self.app.route('/contacts/<int:contact_id>')(self.contact_view)
        self.app.route('/contact/update', methods=['POST'])(self.update_contact)
        self.app.route('/contact/remove', methods=['POST'])(self.remove_contact)
        self.app.route('/contact/add', methods=['POST'])(self.add_contact)
        
        # Contact notes routes
        self.app.route('/contacts/<int:contact_id>/notes/add', methods=['POST'])(self.add_contact_note)
        self.app.route('/contacts/<int:contact_id>/notes/edit', methods=['POST'])(self.contact_note_edit)
        self.app.route('/contacts/<int:contact_id>/notes/remove', methods=['POST'])(self.remove_contact_note)
        
        # Task routes
        self.app.route('/tasks')(self.tasks_list)
        self.app.route('/tasks/<int:task_id>')(self.task_view)
        self.app.route('/tasks/<int:task_id>/edit', methods=['POST'])(self.task_edit)
        self.app.route('/task/remove', methods=['POST'])(self.remove_task)
        self.app.route('/task/complete', methods=['POST'])(self.mark_task_as_complete)
        self.app.route('/task/add', methods=['POST'])(self.add_task)
        
        # Email routes
        self.app.route('/email/send', methods=['POST'])(self.send_email)
        
        # Settings routes
        self.app.route('/settings')(self.settings)
        
        # Admin routes
        self.app.route('/admin/agents')(self.agents_list)
        self.app.route('/admin/agents/<int:agent_id>')(self.agent_view)
        self.app.route('/admin/agent/edit', methods=['POST'])(self.agent_edit)
        self.app.route('/admin/agent/<int:agent_id>/delete')(self.agent_delete)
        self.app.route('/admin/agent/new', methods=['POST'])(self.agent_new)

    def home(self):
        '''
        The home for the Flask application. Redirects to login
        '''
        if 'agent_id' in session:
            return redirect(url_for('agent_home'))
        return redirect(url_for('login'))

    def login(self):
        '''
        Handle user login for both agents and admins.

        GET: Display the login form
        POST: Process the login form submission

        If login is successful, redirect to the agent_home or admin_home page accordingly.
        If login fails, show an error message and redisplay the login form.

        Uses AgentService.login or AdminService.login to verify credentials.
        '''
        if request.method == 'POST':
            agent_id = request.form.get('agent_id', type=int, default=-1)
            agent_email = request.form.get('agent_email', '')
            password = request.form.get('password', '')
            
            # Try admin login first if admin service is available
            if self.admin_service and self.admin_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.admin_service.agent_id
                session['is_admin'] = True
                self.service = self.admin_service
                flash('Admin login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            # Try regular agent login
            if self.agent_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.agent_service.agent_id
                session['is_admin'] = False
                self.service = self.agent_service
                flash('Login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            flash('Invalid credentials. Please try again.', 'error')
        
        return render_template('login.html')

    def logout(self):
        '''
        Handle user logout.
        Clear the user session and redirect to the login page.
        '''
        if 'is_admin' in session and session['is_admin'] and self.admin_service:
            self.admin_service.logout()
        else:
            self.agent_service.logout()
        
        session.clear()
        self.service = self.agent_service
        flash('You have been logged out.', 'info')
        return redirect(url_for('login'))

    def agent_home(self):
        '''
        Display the home/start page of the agent. Render agent_home.html
        On top of this page, show a dashboard with
        - Home: return to this page.
        - Companies: go to companies_list
        - Contacts: go to contacts_list
        - Tasks: go to tasks_list
        - Email: go to email_page
        - Settings: go to settings_list
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        agent = self.service.show_setting()
        
        return render_template('agent_home.html', agent=agent, is_admin=session.get('is_admin', False))

    def companies_list(self):
        '''
        Display the list of companies, AgentService.get_all_companies()

        Shows a paginated, sortable, and filterable list of companies.
        Includes search functionality.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        # Get sorting preference from query parameters
        order_by_target_funding = request.args.get('order_by_target_funding', 'false').lower() == 'true'
        
        try:
            # Get companies
            self.service.get_all_companies(order_by_target_funding=order_by_target_funding)
            companies = list(self.service.companies.values())
            
            return render_template('companies_list.html', companies=companies)
        except Exception as e:
            logger.error(f"Error in companies_list: {str(e)}")
            flash(f'Error retrieving companies: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def add_company(self):
        '''
        Add a new company to the service and database, using self.service.add_company()
        All attribute, expect for company_id will be read from the request form.
        Users will not specify company_id.
        E.g. main_contact_id = int(request.form.get("main_contact_id")).
        -- redirect(url_for('agent_home')) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name')
            main_contact_id = int(request.form.get('main_contact_id'))
            target_funding = float(request.form.get('target_funding'))
            grant_type = request.form.get('grant_type', '')
            status = request.form.get('status', 'New')
            renewal_date = request.form.get('renewal_date', '')
            
            company = self.service.add_company(
                name=name,
                main_contact_id=main_contact_id,
                target_funding=target_funding,
                grant_type=grant_type,
                status=status,
                renewal_date=renewal_date
            )
            
            flash(f'Company {name} added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_company: {str(e)}")
            flash(f'Error adding company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def company_view(self, company_id):
        '''
        View one company.
        Display all attribute about a specific company (Company class), AgentService.get_company()
        Display all notes (self.service.get_company_notes(company_id, order_by_create_date=True))
                and contacts for this company (self.service.show_all_company_contacts(company_id))
        Render company_view.html
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company = self.service.get_company(company_id)
            notes = self.service.get_company_notes(company_id, order_by_create_date=True)
            contacts = self.service.show_all_company_contacts(company_id)
            tasks = self.service.show_all_company_tasks(company_id)
            
            return render_template(
                'company_view.html',
                company=company,
                notes=notes,
                contacts=contacts,
                tasks=tasks
            )
        except Exception as e:
            logger.error(f"Error in company_view: {str(e)}")
            flash(f'Error retrieving company: {str(e)}', 'error')
            return redirect(url_for('companies_list'))

    def update_companies(self):
        '''
        Allow edit to each attribute of many Company, call AgentService.update_company() in a for loop,
            for each modified company.
        All attribute that needed to be updated and company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_ids = request.form.getlist('company_id')
            names = request.form.getlist('name')
            main_contact_ids = request.form.getlist('main_contact_id')
            target_fundings = request.form.getlist('target_funding')
            grant_types = request.form.getlist('grant_type')
            statuses = request.form.getlist('status')
            renewal_dates = request.form.getlist('renewal_date')
            
            for i in range(len(company_ids)):
                company_id = int(company_ids[i])
                updates = {}
                
                if i < len(names) and names[i]:
                    updates['name'] = names[i]
                if i < len(main_contact_ids) and main_contact_ids[i]:
                    updates['main_contact_id'] = int(main_contact_ids[i])
                if i < len(target_fundings) and target_fundings[i]:
                    updates['target_funding'] = float(target_fundings[i])
                if i < len(grant_types) and grant_types[i]:
                    updates['grant_type'] = grant_types[i]
                if i < len(statuses) and statuses[i]:
                    updates['status'] = statuses[i]
                if i < len(renewal_dates) and renewal_dates[i]:
                    updates['renewal_date'] = renewal_dates[i]
                
                if updates:
                    self.service.update_company(company_id, **updates)
            
            flash('Companies updated successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in update_companies: {str(e)}")
            flash(f'Error updating companies: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def update_company(self):
        '''
        Allow edit to each attribute of a Company, AgentService.update_company()
        All attribute that needed to be updated and company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_id = int(request.form.get('company_id'))
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('main_contact_id'):
                updates['main_contact_id'] = int(request.form.get('main_contact_id'))
            if request.form.get('target_funding'):
                updates['target_funding'] = float(request.form.get('target_funding'))
            if request.form.get('grant_type'):
                updates['grant_type'] = request.form.get('grant_type')
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            if request.form.get('renewal_date'):
                updates['renewal_date'] = request.form.get('renewal_date')
            
            if updates:
                self.service.update_company(company_id, **updates)
                flash('Company updated successfully!', 'success')
                return redirect(url_for('company_view', company_id=company_id))
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in update_company: {str(e)}")
            flash(f'Error updating company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def remove_company(self):
        '''
        Allow delete a company, AgentService.remove_company()
        The company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('agent_home')) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_id = int(request.form.get('company_id'))
            
            if self.service.remove_company(company_id):
                flash('Company deleted successfully!', 'success')
            else:
                flash('Failed to delete company.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_company: {str(e)}")
            flash(f'Error deleting company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def company_note_edit(self, company_id: int):
        '''
        Allow edit to each attribute of a CompanyNote, AgentService.update_company_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_note_id = int(request.form.get('company_note_id'))
            new_note = request.form.get('note', '')
            
            self.service.update_company_note(
                company_id=company_id,
                company_note_id=company_note_id,
                new_note=new_note
            )
            
            flash('Note updated successfully!', 'success')
            return redirect(url_for('company_view', company_id=company_id))
        except Exception as e:
            logger.error(f"Error in company_note_edit: {str(e)}")
            flash(f'Error updating note: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def remove_company_note(self, company_id: int):
        '''
        Allow delete a CompanyNote, AgentService.delete_company_note()
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_note_id = int(request.form.get('company_note_id'))
            
            if self.service.remove_company_note(company_id, company_note_id):
                flash('Note deleted successfully!', 'success')
                return redirect(url_for('company_view', company_id=company_id))
            else:
                flash('Failed to delete note.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_company_note: {str(e)}")
            flash(f'Error deleting note: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def add_company_note(self, company_id: int):
        '''
        Handle creation of a new company note.
        POST: Process the form submission and create a new company note
        Uses AgentService.add_company_note() to create the company note.
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            new_note = request.form.get('note', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_company_note(
                company_id=company_id,
                new_note=new_note,
                create_time=create_time
            )
            
            flash('Note added successfully!', 'success')
            return redirect(url_for('company_view', company_id=company_id))
        except Exception as e:
            logger.error(f"Error in add_company_note: {str(e)}")
            flash(f'Error adding note: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def contacts_list(self):
        '''
        Display the list of contacts, AgentService.get_all_contacts()
        Shows a paginated, sortable, and filterable list of contacts.
        Includes search functionality.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Get sorting preference from query parameters
            sort_by_companies = request.args.get('sort_by_companies', 'true').lower() == 'true'
            
            # Get contacts
            self.service.get_all_contacts(sort_by_companies=sort_by_companies)
            contacts = list(self.service.contacts.values())
            
            return render_template('contacts_list.html', contacts=contacts)
        except Exception as e:
            logger.error(f"Error in contacts_list: {str(e)}")
            flash(f'Error retrieving contacts: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def contact_view(self, contact_id):
        '''
        Display detailed information about a specific contact, AgentService.get_contact()
        Shows all attribute of a Contact class:
        Show all contact notes, AgentService.get_contact_notes()
        render_template('contact_view.html') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact = self.service.get_contact(contact_id)
            notes = self.service.get_contact_notes(contact_id)
            
            # Get company if available
            company = None
            if contact.company_id > 0:
                try:
                    company = self.service.get_company(contact.company_id)
                except Exception:
                    pass
            
            return render_template(
                'contact_view.html',
                contact=contact,
                notes=notes,
                company=company
            )
        except Exception as e:
            logger.error(f"Error in contact_view: {str(e)}")
            flash(f'Error retrieving contact: {str(e)}', 'error')
            return redirect(url_for('contacts_list'))

    def update_contact(self):
        '''
        Allow edit to each attribute of a Contact, AgentService.update_contact()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id = int(request.form.get('contact_id'))
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('email'):
                updates['email'] = request.form.get('email')
            if request.form.get('company_id'):
                updates['company_id'] = int(request.form.get('company_id'))
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            
            if updates:
                self.service.update_contact(contact_id, **updates)
                flash('Contact updated successfully!', 'success')
                return redirect(url_for('contact_view', contact_id=contact_id))
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in update_contact: {str(e)}")
            flash(f'Error updating contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def remove_contact(self):
        '''
        Allow delete a contact, AgentService.remove_contact()
        contact_id be read from the request form.
        -- redirect(url_for('agent_home') + '#contacts-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id = int(request.form.get('contact_id'))
            
            if self.service.remove_contact(contact_id):
                flash('Contact deleted successfully!', 'success')
            else:
                flash('Failed to delete contact.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_contact: {str(e)}")
            flash(f'Error deleting contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#contacts-tab')

    def add_contact(self):
        '''
        Handle creation of a new contact, AgentService.add_contact()
        POST: Process the form submission and create a new contact
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#contacts-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name')
            email = request.form.get('email')
            company_id = int(request.form.get('company_id'))
            status = request.form.get('status', 'new')
            
            contact = self.service.add_contact(
                name=name,
                email=email,
                company_id=company_id,
                assigned_agent_id=session['agent_id'],
                status=status
            )
            
            flash(f'Contact {name} added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_contact: {str(e)}")
            flash(f'Error adding contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#contacts-tab')

    def contact_note_edit(self, contact_id):
        '''
        Allow edit to each attribute of a ContactNote, AgentService.update_contact_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_note_id = int(request.form.get('contact_note_id'))
            new_note = request.form.get('note', '')
            
            self.service.update_contact_note(
                contact_id=contact_id,
                contact_note_id=contact_note_id,
                note=new_note
            )
            
            flash('Note updated successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in contact_note_edit: {str(e)}")
            flash(f'Error updating note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def remove_contact_note(self, contact_id):
        '''
        Allow delete a Contact Note, AgentService.remove_contact_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_note_id = int(request.form.get('contact_note_id'))
            
            if self.service.remove_contact_note(contact_id, contact_note_id):
                flash('Note deleted successfully!', 'success')
            else:
                flash('Failed to delete note.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_contact_note: {str(e)}")
            flash(f'Error deleting note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def add_contact_note(self, contact_id):
        '''
        Handle creation of a new contact note, AgentService.add_contact_note()
        POST: Process the form submission and create a new contact note
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            new_note = request.form.get('note', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_contact_note(
                contact_id=contact_id,
                new_note=new_note,
                assigned_agent_id=session['agent_id'],
                create_time=create_time
            )
            
            flash('Note added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_contact_note: {str(e)}")
            flash(f'Error adding note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def tasks_list(self):
        '''
        Display the list of tasks, AgentService.get_all_tasks()
        Shows a paginated, sortable, and filterable list of tasks.
        Includes search functionality and filtering by status, priority, and due date.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Get sorting preference from query parameters
            order_by_due_date = request.args.get('order_by_due_date', 'true').lower() == 'true'
            
            # Get tasks
            self.service.get_all_tasks(order_by_due_date=order_by_due_date)
            tasks = list(self.service.tasks.values())
            
            return render_template('tasks_list.html', tasks=tasks)
        except Exception as e:
            logger.error(f"Error in tasks_list: {str(e)}")
            flash(f'Error retrieving tasks: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def task_view(self, task_id):
        '''
        Display the attributes of a specific task (Task class), AgentService.get_task()
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Find task in service.tasks
            task = None
            for t in self.service.tasks.values():
                if t.task_id == task_id:
                    task = t
                    break
            
            if not task:
                flash('Task not found.', 'error')
                return redirect(url_for('tasks_list'))
            
            return render_template('task_view.html', task=task)
        except Exception as e:
            logger.error(f"Error in task_view: {str(e)}")
            flash(f'Error retrieving task: {str(e)}', 'error')
            return redirect(url_for('tasks_list'))

    def task_edit(self, task_id):
        '''
        Allow edit to each attribute of a Task, AgentService.update_task()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('description'):
                updates['description'] = request.form.get('description')
            if request.form.get('contact_id'):
                updates['contact_id'] = int(request.form.get('contact_id'))
            if request.form.get('company_id'):
                updates['company_id'] = int(request.form.get('company_id'))
            if request.form.get('due_time'):
                updates['due_time'] = request.form.get('due_time')
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            
            if updates:
                self.service.update_task(task_id, **updates)
                flash('Task updated successfully!', 'success')
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in task_edit: {str(e)}")
            flash(f'Error updating task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def remove_task(self):
        '''
        Allow delete a task, AgentService.delete_task()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            task_id = int(request.form.get('task_id'))
            
            if self.service.remove_task(task_id):
                flash('Task deleted successfully!', 'success')
            else:
                flash('Failed to delete task.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_task: {str(e)}")
            flash(f'Error deleting task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def mark_task_as_complete(self):
        '''
        Mark a task as complete, AgentService.update_task()
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            task_id = int(request.form.get('task_id'))
            
            self.service.update_task(task_id, status='complete')
            flash('Task marked as complete!', 'success')
        except Exception as e:
            logger.error(f"Error in mark_task_as_complete: {str(e)}")
            flash(f'Error updating task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def add_task(self):
        '''
        Handle creation of a new task, AgentService.add_task()
        POST: Process the form submission and create a new task
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name')
            description = request.form.get('description', '')
            contact_id = int(request.form.get('contact_id'))
            company_id = int(request.form.get('company_id'))
            due_time = request.form.get('due_time', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_task(
                assigned_agent_id=session['agent_id'],
                contact_id=contact_id,
                company_id=company_id,
                name=name,
                description=description,
                create_time=create_time,
                due_time=due_time,
                status='incomplete'
            )
            
            flash(f'Task "{name}" added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_task: {str(e)}")
            flash(f'Error adding task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def send_email(self):
        '''
        Handle composition and sending of a new email, AgentService.send_email()
        POST: Process the form submission and send the email
        -- redirect(url_for('agent_home') + '#email-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id = int(request.form.get('contact_id'))
            email_subject = request.form.get('subject', '')
            email_content = request.form.get('content', '')
            
            if self.service.send_email(contact_id, email_subject, email_content):
                flash('Email sent successfully!', 'success')
            else:
                flash('Failed to send email.', 'error')
        except Exception as e:
            logger.error(f"Error in send_email: {str(e)}")
            flash(f'Error sending email: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#email-tab')

    def settings(self):
        '''
        Handle agent settings.
        Display all attributes of Agent
        POST: Process the form submission and update settings
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        agent = self.service.show_setting()
        
        return render_template('settings.html', agent=agent, is_admin=session.get('is_admin', False))

    def agents_list(self):
        '''
        (admin only)
        Display the list of agents: AdminAgentService.get_all_agents()
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            # Get all agents
            self.admin_service.get_all_agents()
            agents = list(self.admin_service.agents.values())
            
            return render_template('agents_list.html', agents=agents)
        except Exception as e:
            logger.error(f"Error in agents_list: {str(e)}")
            flash(f'Error retrieving agents: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def agent_view(self, agent_id):
        '''
        (admin only)
        Display attributes about a specific agent (Agent class), AdminAgentService.get_agent()
        render_template('agent_view.html', agent_id=agent_id) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            agent = self.admin_service.get_agent(agent_id)
            return render_template('agent_view.html', agent=agent)
        except Exception as e:
            logger.error(f"Error in agent_view: {str(e)}")
            flash(f'Error retrieving agent: {str(e)}', 'error')
            return redirect(url_for('agents_list'))

    def agent_edit(self):
        '''
        (admin only)
        Allow edit to each attribute of a Agent, AdminAgentService.update_agent()
        All attribute that needed to be updated and agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            agent_id = int(request.form.get('agent_id'))
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('email'):
                updates['email'] = request.form.get('email')
            if request.form.get('password'):
                updates['password'] = request.form.get('password')
            if request.form.get('phone'):
                updates['phone'] = request.form.get('phone')
            if request.form.get('org'):
                updates['org'] = request.form.get('org')
            if request.form.get('role'):
                updates['role'] = request.form.get('role')
            if 'is_admin' in request.form:
                updates['is_admin'] = request.form.get('is_admin').lower() == 'true'
            
            if updates:
                self.admin_service.update_agent(agent_id, **updates)
                flash('Agent updated successfully!', 'success')
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in agent_edit: {str(e)}")
            flash(f'Error updating agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

    def agent_delete(self, agent_id):
        '''
        (admin only)
        Allow delete an agent, AdminAgentService.delete_agent()
        Agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            # Prevent self-deletion
            if int(agent_id) == int(session['agent_id']):
                flash('Cannot delete your own account.', 'error')
                return redirect(url_for('agents_list'))
            
            if self.admin_service.remove_agent(agent_id):
                flash('Agent deleted successfully!', 'success')
            else:
                flash('Failed to delete agent.', 'error')
        except Exception as e:
            logger.error(f"Error in agent_delete: {str(e)}")
            flash(f'Error deleting agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

    def agent_new(self):
        '''
        (admin only)
        Handle creation of a new agent: AdminAgentService.add_agent()
        POST: Process the form submission and create a new agent
        All attribute that needed to be updated and agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            name = request.form.get('name')
            email = request.form.get('email')
            password = request.form.get('password')
            phone = request.form.get('phone', '')
            org = request.form.get('org', '')
            role = request.form.get('role', '')
            is_admin = request.form.get('is_admin', '').lower() == 'true'
            
            self.admin_service.create_agent(
                name=name,
                email=email,
                password=password,
                phone=phone,
                org=org,
                role=role,
                is_admin=is_admin
            )
            
            flash(f'Agent {name} created successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in agent_new: {str(e)}")
            flash(f'Error creating agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

Review:

# Transpilation Review
The transpilation is not correct. There are multiple type checking errors related to handling optional values from form inputs and query parameters.

## Compilation Review
### Failures
The main issues are:
1. Not properly checking if form values exist before converting them to int/float
2. Not providing default values for optional form inputs
3. Not handling None values properly when passing to service methods
4. Type mismatches between what's expected by service methods and what's being passed

### Fixes
The fixes involve:

1. **Form value handling**: Always check if a form value exists and provide a default value before converting to int/float
   ```python
   # Instead of:
   main_contact_id = int(request.form.get('main_contact_id'))
   
   # Do:
   main_contact_id_str = request.form.get('main_contact_id')
   main_contact_id = int(main_contact_id_str) if main_contact_id_str else -1
   ```

2. **Service method arguments**: Ensure required arguments are not None before passing to service methods
   ```python
   # Instead of:
   name = request.form.get('name')
   self.service.add_company(name=name, ...)
   
   # Do:
   name = request.form.get('name', '')  # Default to empty string
   if not name:
       flash('Name is required', 'error')
       return redirect(url_for('agent_home'))
   self.service.add_company(name=name, ...)
   ```

3. **Boolean handling**: Properly handle boolean values from form inputs
   ```python
   # Instead of:
   is_admin = request.form.get('is_admin', '').lower() == 'true'
   
   # Do:
   is_admin_str = request.form.get('is_admin', '')
   is_admin = is_admin_str.lower() == 'true' if is_admin_str else False
   ```

These patterns need to be applied throughout the file wherever form values are processed.

## Testing Review
No testing errors were provided, only compilation errors.

## Failures due to other causes
All errors appear to be within this file and related to type checking.


---------------------------------------------
Step 6: Implementing the actual code (implementation and review):

Implemmentation:

"""Defines all routes for the Flask application, mapping URLs to view functions"""

import typing as t
from datetime import datetime
from flask import Flask, request, session, redirect, url_for, render_template, flash, jsonify
from backend_services.agent_service import AgentService
from backend_services.admin_service import AdminAgentService
from database.schema import Schema
from backend_services.data_models import Agent, CompanyNote, Company, Contact, ContactNote, Task, EmailTemplate
from database.db_operations import PostgresOperations
import logging

logger = logging.getLogger(__name__)


class Routes:
    '''
    This class defines all the route handlers for the CRM application.
    It handles routing for all pages including login, home, companies, contacts, tasks, email, settings, and admin pages.
    '''

    def __init__(self,
                 app: Flask,
                 agent_service: AgentService,
                 admin_service: t.Optional[AdminAgentService]=None,
                 ):
        '''
        Initialize the Routes class with the Flask app and all required services.

        Parameters:
        - app: The Flask application instance
        - agent_service: Services for an agent
        - admin_agent_service: Services for an admin agent (who can do whatever an agent can do and add/remove agent)
        '''
        self.app = app
        self.agent_service = agent_service
        self.admin_service = admin_service
        self.service = self.agent_service
        self.register_routes()

    def register_routes(self) -> None:
        '''
        Register all route handlers with the Flask application.
        This method sets up all the URL routes and connects them to their respective handler methods, defined below
        '''
        # Authentication routes
        self.app.route('/')(self.home)
        self.app.route('/login', methods=['GET', 'POST'])(self.login)
        self.app.route('/logout')(self.logout)
        
        # Agent home
        self.app.route('/agent/home')(self.agent_home)
        
        # Company routes
        self.app.route('/companies')(self.companies_list)
        self.app.route('/companies/add', methods=['POST'])(self.add_company)
        self.app.route('/companies/<int:company_id>')(self.company_view)
        self.app.route('/companies/update', methods=['POST'])(self.update_companies)
        self.app.route('/company/update', methods=['POST'])(self.update_company)
        self.app.route('/company/remove', methods=['POST'])(self.remove_company)
        
        # Company notes routes
        self.app.route('/companies/<int:company_id>/notes/add', methods=['POST'])(self.add_company_note)
        self.app.route('/companies/<int:company_id>/notes/edit', methods=['POST'])(self.company_note_edit)
        self.app.route('/companies/<int:company_id>/notes/remove', methods=['POST'])(self.remove_company_note)
        
        # Contact routes
        self.app.route('/contacts')(self.contacts_list)
        self.app.route('/contacts/<int:contact_id>')(self.contact_view)
        self.app.route('/contact/update', methods=['POST'])(self.update_contact)
        self.app.route('/contact/remove', methods=['POST'])(self.remove_contact)
        self.app.route('/contact/add', methods=['POST'])(self.add_contact)
        
        # Contact notes routes
        self.app.route('/contacts/<int:contact_id>/notes/add', methods=['POST'])(self.add_contact_note)
        self.app.route('/contacts/<int:contact_id>/notes/edit', methods=['POST'])(self.contact_note_edit)
        self.app.route('/contacts/<int:contact_id>/notes/remove', methods=['POST'])(self.remove_contact_note)
        
        # Task routes
        self.app.route('/tasks')(self.tasks_list)
        self.app.route('/tasks/<int:task_id>')(self.task_view)
        self.app.route('/tasks/<int:task_id>/edit', methods=['POST'])(self.task_edit)
        self.app.route('/task/remove', methods=['POST'])(self.remove_task)
        self.app.route('/task/complete', methods=['POST'])(self.mark_task_as_complete)
        self.app.route('/task/add', methods=['POST'])(self.add_task)
        
        # Email routes
        self.app.route('/email/send', methods=['POST'])(self.send_email)
        
        # Settings routes
        self.app.route('/settings')(self.settings)
        
        # Admin routes
        self.app.route('/admin/agents')(self.agents_list)
        self.app.route('/admin/agents/<int:agent_id>')(self.agent_view)
        self.app.route('/admin/agent/edit', methods=['POST'])(self.agent_edit)
        self.app.route('/admin/agent/<int:agent_id>/delete')(self.agent_delete)
        self.app.route('/admin/agent/new', methods=['POST'])(self.agent_new)

    def home(self):
        '''
        The home for the Flask application. Redirects to login
        '''
        if 'agent_id' in session:
            return redirect(url_for('agent_home'))
        return redirect(url_for('login'))

    def login(self):
        '''
        Handle user login for both agents and admins.

        GET: Display the login form
        POST: Process the login form submission

        If login is successful, redirect to the agent_home or admin_home page accordingly.
        If login fails, show an error message and redisplay the login form.

        Uses AgentService.login or AdminService.login to verify credentials.
        '''
        if request.method == 'POST':
            agent_id_str = request.form.get('agent_id')
            agent_id = int(agent_id_str) if agent_id_str and agent_id_str.isdigit() else -1
            agent_email = request.form.get('agent_email', '')
            password = request.form.get('password', '')
            
            # Try admin login first if admin service is available
            if self.admin_service and self.admin_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.admin_service.agent_id
                session['is_admin'] = True
                self.service = self.admin_service
                flash('Admin login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            # Try regular agent login
            if self.agent_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.agent_service.agent_id
                session['is_admin'] = False
                self.service = self.agent_service
                flash('Login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            flash('Invalid credentials. Please try again.', 'error')
        
        return render_template('login.html')

    def logout(self):
        '''
        Handle user logout.
        Clear the user session and redirect to the login page.
        '''
        if 'is_admin' in session and session['is_admin'] and self.admin_service:
            self.admin_service.logout()
        else:
            self.agent_service.logout()
        
        session.clear()
        self.service = self.agent_service
        flash('You have been logged out.', 'info')
        return redirect(url_for('login'))

    def agent_home(self):
        '''
        Display the home/start page of the agent. Render agent_home.html
        On top of this page, show a dashboard with
        - Home: return to this page.
        - Companies: go to companies_list
        - Contacts: go to contacts_list
        - Tasks: go to tasks_list
        - Email: go to email_page
        - Settings: go to settings_list
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        agent = self.service.show_setting()
        
        return render_template('agent_home.html', agent=agent, is_admin=session.get('is_admin', False))

    def companies_list(self):
        '''
        Display the list of companies, AgentService.get_all_companies()

        Shows a paginated, sortable, and filterable list of companies.
        Includes search functionality.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        # Get sorting preference from query parameters
        order_by_target_funding = request.args.get('order_by_target_funding', 'false').lower() == 'true'
        
        try:
            # Get companies
            self.service.get_all_companies(order_by_target_funding=order_by_target_funding)
            companies = list(self.service.companies.values())
            
            return render_template('companies_list.html', companies=companies)
        except Exception as e:
            logger.error(f"Error in companies_list: {str(e)}")
            flash(f'Error retrieving companies: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def add_company(self):
        '''
        Add a new company to the service and database, using self.service.add_company()
        All attribute, expect for company_id will be read from the request form.
        Users will not specify company_id.
        E.g. main_contact_id = int(request.form.get("main_contact_id")).
        -- redirect(url_for('agent_home')) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Company name is required.', 'error')
                return redirect(url_for('agent_home'))
                
            main_contact_id_str = request.form.get('main_contact_id')
            main_contact_id = int(main_contact_id_str) if main_contact_id_str and main_contact_id_str.isdigit() else -1
            
            target_funding_str = request.form.get('target_funding')
            target_funding = float(target_funding_str) if target_funding_str else 0.0
            
            grant_type = request.form.get('grant_type', '')
            status = request.form.get('status', 'New')
            renewal_date = request.form.get('renewal_date', '')
            
            company = self.service.add_company(
                name=name,
                main_contact_id=main_contact_id,
                target_funding=target_funding,
                grant_type=grant_type,
                status=status,
                renewal_date=renewal_date
            )
            
            flash(f'Company {name} added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_company: {str(e)}")
            flash(f'Error adding company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def company_view(self, company_id):
        '''
        View one company.
        Display all attribute about a specific company (Company class), AgentService.get_company()
        Display all notes (self.service.get_company_notes(company_id, order_by_create_date=True))
                and contacts for this company (self.service.show_all_company_contacts(company_id))
        Render company_view.html
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company = self.service.get_company(company_id)
            notes = self.service.get_company_notes(company_id, order_by_create_date=True)
            contacts = self.service.show_all_company_contacts(company_id)
            tasks = self.service.show_all_company_tasks(company_id)
            
            return render_template(
                'company_view.html',
                company=company,
                notes=notes,
                contacts=contacts,
                tasks=tasks
            )
        except Exception as e:
            logger.error(f"Error in company_view: {str(e)}")
            flash(f'Error retrieving company: {str(e)}', 'error')
            return redirect(url_for('companies_list'))

    def update_companies(self):
        '''
        Allow edit to each attribute of many Company, call AgentService.update_company() in a for loop,
            for each modified company.
        All attribute that needed to be updated and company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_ids = request.form.getlist('company_id')
            names = request.form.getlist('name')
            main_contact_ids = request.form.getlist('main_contact_id')
            target_fundings = request.form.getlist('target_funding')
            grant_types = request.form.getlist('grant_type')
            statuses = request.form.getlist('status')
            renewal_dates = request.form.getlist('renewal_date')
            
            for i in range(len(company_ids)):
                company_id_str = company_ids[i]
                if not company_id_str or not company_id_str.isdigit():
                    continue
                    
                company_id = int(company_id_str)
                updates = {}
                
                if i < len(names) and names[i]:
                    updates['name'] = names[i]
                if i < len(main_contact_ids) and main_contact_ids[i] and main_contact_ids[i].isdigit():
                    updates['main_contact_id'] = int(main_contact_ids[i])
                if i < len(target_fundings) and target_fundings[i]:
                    try:
                        updates['target_funding'] = float(target_fundings[i])
                    except ValueError:
                        pass
                if i < len(grant_types) and grant_types[i]:
                    updates['grant_type'] = grant_types[i]
                if i < len(statuses) and statuses[i]:
                    updates['status'] = statuses[i]
                if i < len(renewal_dates) and renewal_dates[i]:
                    updates['renewal_date'] = renewal_dates[i]
                
                if updates:
                    self.service.update_company(company_id, **updates)
            
            flash('Companies updated successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in update_companies: {str(e)}")
            flash(f'Error updating companies: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def update_company(self):
        '''
        Allow edit to each attribute of a Company, AgentService.update_company()
        All attribute that needed to be updated and company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_id_str = request.form.get('company_id')
            if not company_id_str or not company_id_str.isdigit():
                flash('Invalid company ID.', 'error')
                return redirect(url_for('agent_home'))
                
            company_id = int(company_id_str)
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
                
            main_contact_id_str = request.form.get('main_contact_id')
            if main_contact_id_str and main_contact_id_str.isdigit():
                updates['main_contact_id'] = int(main_contact_id_str)
                
            target_funding_str = request.form.get('target_funding')
            if target_funding_str:
                try:
                    updates['target_funding'] = float(target_funding_str)
                except ValueError:
                    pass
                    
            if request.form.get('grant_type'):
                updates['grant_type'] = request.form.get('grant_type')
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            if request.form.get('renewal_date'):
                updates['renewal_date'] = request.form.get('renewal_date')
            
            if updates:
                self.service.update_company(company_id, **updates)
                flash('Company updated successfully!', 'success')
                return redirect(url_for('company_view', company_id=company_id))
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in update_company: {str(e)}")
            flash(f'Error updating company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def remove_company(self):
        '''
        Allow delete a company, AgentService.remove_company()
        The company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('agent_home')) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_id_str = request.form.get('company_id')
            if not company_id_str or not company_id_str.isdigit():
                flash('Invalid company ID.', 'error')
                return redirect(url_for('agent_home'))
                
            company_id = int(company_id_str)
            
            if self.service.remove_company(company_id):
                flash('Company deleted successfully!', 'success')
            else:
                flash('Failed to delete company.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_company: {str(e)}")
            flash(f'Error deleting company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def company_note_edit(self, company_id: int):
        '''
        Allow edit to each attribute of a CompanyNote, AgentService.update_company_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_note_id_str = request.form.get('company_note_id')
            if not company_note_id_str or not company_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('agent_home'))
                
            company_note_id = int(company_note_id_str)
            new_note = request.form.get('note', '')
            
            self.service.update_company_note(
                company_id=company_id,
                company_note_id=company_note_id,
                new_note=new_note
            )
            
            flash('Note updated successfully!', 'success')
            return redirect(url_for('company_view', company_id=company_id))
        except Exception as e:
            logger.error(f"Error in company_note_edit: {str(e)}")
            flash(f'Error updating note: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def remove_company_note(self, company_id: int):
        '''
        Allow delete a CompanyNote, AgentService.delete_company_note()
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_note_id_str = request.form.get('company_note_id')
            if not company_note_id_str or not company_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('company_view', company_id=company_id))
                
            company_note_id = int(company_note_id_str)
            
            if self.service.remove_company_note(company_id, company_note_id):
                flash('Note deleted successfully!', 'success')
                return redirect(url_for('company_view', company_id=company_id))
            else:
                flash('Failed to delete note.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_company_note: {str(e)}")
            flash(f'Error deleting note: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def add_company_note(self, company_id: int):
        '''
        Handle creation of a new company note.
        POST: Process the form submission and create a new company note
        Uses AgentService.add_company_note() to create the company note.
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            new_note = request.form.get('note', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_company_note(
                company_id=company_id,
                new_note=new_note,
                create_time=create_time
            )
            
            flash('Note added successfully!', 'success')
            return redirect(url_for('company_view', company_id=company_id))
        except Exception as e:
            logger.error(f"Error in add_company_note: {str(e)}")
            flash(f'Error adding note: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def contacts_list(self):
        '''
        Display the list of contacts, AgentService.get_all_contacts()
        Shows a paginated, sortable, and filterable list of contacts.
        Includes search functionality.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Get sorting preference from query parameters
            sort_by_companies = request.args.get('sort_by_companies', 'true').lower() == 'true'
            
            # Get contacts
            self.service.get_all_contacts(sort_by_companies=sort_by_companies)
            contacts = list(self.service.contacts.values())
            
            return render_template('contacts_list.html', contacts=contacts)
        except Exception as e:
            logger.error(f"Error in contacts_list: {str(e)}")
            flash(f'Error retrieving contacts: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def contact_view(self, contact_id):
        '''
        Display detailed information about a specific contact, AgentService.get_contact()
        Shows all attribute of a Contact class:
        Show all contact notes, AgentService.get_contact_notes()
        render_template('contact_view.html') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact = self.service.get_contact(contact_id)
            notes = self.service.get_contact_notes(contact_id)
            
            # Get company if available
            company = None
            if contact.company_id > 0:
                try:
                    company = self.service.get_company(contact.company_id)
                except Exception:
                    pass
            
            return render_template(
                'contact_view.html',
                contact=contact,
                notes=notes,
                company=company
            )
        except Exception as e:
            logger.error(f"Error in contact_view: {str(e)}")
            flash(f'Error retrieving contact: {str(e)}', 'error')
            return redirect(url_for('contacts_list'))

    def update_contact(self):
        '''
        Allow edit to each attribute of a Contact, AgentService.update_contact()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id_str = request.form.get('contact_id')
            if not contact_id_str or not contact_id_str.isdigit():
                flash('Invalid contact ID.', 'error')
                return redirect(url_for('agent_home'))
                
            contact_id = int(contact_id_str)
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('email'):
                updates['email'] = request.form.get('email')
                
            company_id_str = request.form.get('company_id')
            if company_id_str and company_id_str.isdigit():
                updates['company_id'] = int(company_id_str)
                
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            
            if updates:
                self.service.update_contact(contact_id, **updates)
                flash('Contact updated successfully!', 'success')
                return redirect(url_for('contact_view', contact_id=contact_id))
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in update_contact: {str(e)}")
            flash(f'Error updating contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def remove_contact(self):
        '''
        Allow delete a contact, AgentService.remove_contact()
        contact_id be read from the request form.
        -- redirect(url_for('agent_home') + '#contacts-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id_str = request.form.get('contact_id')
            if not contact_id_str or not contact_id_str.isdigit():
                flash('Invalid contact ID.', 'error')
                return redirect(url_for('agent_home') + '#contacts-tab')
                
            contact_id = int(contact_id_str)
            
            if self.service.remove_contact(contact_id):
                flash('Contact deleted successfully!', 'success')
            else:
                flash('Failed to delete contact.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_contact: {str(e)}")
            flash(f'Error deleting contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#contacts-tab')

    def add_contact(self):
        '''
        Handle creation of a new contact, AgentService.add_contact()
        POST: Process the form submission and create a new contact
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#contacts-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Contact name is required.', 'error')
                return redirect(url_for('agent_home') + '#contacts-tab')
                
            email = request.form.get('email', '')
            if not email:
                flash('Contact email is required.', 'error')
                return redirect(url_for('agent_home') + '#contacts-tab')
                
            company_id_str = request.form.get('company_id')
            company_id = int(company_id_str) if company_id_str and company_id_str.isdigit() else -1
            
            status = request.form.get('status', 'new')
            
            contact = self.service.add_contact(
                name=name,
                email=email,
                company_id=company_id,
                assigned_agent_id=session['agent_id'],
                status=status
            )
            
            flash(f'Contact {name} added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_contact: {str(e)}")
            flash(f'Error adding contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#contacts-tab')

    def contact_note_edit(self, contact_id):
        '''
        Allow edit to each attribute of a ContactNote, AgentService.update_contact_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_note_id_str = request.form.get('contact_note_id')
            if not contact_note_id_str or not contact_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('contact_view', contact_id=contact_id))
                
            contact_note_id = int(contact_note_id_str)
            new_note = request.form.get('note', '')
            
            self.service.update_contact_note(
                contact_id=contact_id,
                contact_note_id=contact_note_id,
                note=new_note
            )
            
            flash('Note updated successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in contact_note_edit: {str(e)}")
            flash(f'Error updating note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def remove_contact_note(self, contact_id):
        '''
        Allow delete a Contact Note, AgentService.remove_contact_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_note_id_str = request.form.get('contact_note_id')
            if not contact_note_id_str or not contact_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('contact_view', contact_id=contact_id))
                
            contact_note_id = int(contact_note_id_str)
            
            if self.service.remove_contact_note(contact_id, contact_note_id):
                flash('Note deleted successfully!', 'success')
            else:
                flash('Failed to delete note.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_contact_note: {str(e)}")
            flash(f'Error deleting note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def add_contact_note(self, contact_id):
        '''
        Handle creation of a new contact note, AgentService.add_contact_note()
        POST: Process the form submission and create a new contact note
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            new_note = request.form.get('note', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_contact_note(
                contact_id=contact_id,
                new_note=new_note,
                assigned_agent_id=session['agent_id'],
                create_time=create_time
            )
            
            flash('Note added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_contact_note: {str(e)}")
            flash(f'Error adding note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def tasks_list(self):
        '''
        Display the list of tasks, AgentService.get_all_tasks()
        Shows a paginated, sortable, and filterable list of tasks.
        Includes search functionality and filtering by status, priority, and due date.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Get sorting preference from query parameters
            order_by_due_date = request.args.get('order_by_due_date', 'true').lower() == 'true'
            
            # Get tasks
            self.service.get_all_tasks(order_by_due_date=order_by_due_date)
            tasks = list(self.service.tasks.values())
            
            return render_template('tasks_list.html', tasks=tasks)
        except Exception as e:
            logger.error(f"Error in tasks_list: {str(e)}")
            flash(f'Error retrieving tasks: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def task_view(self, task_id):
        '''
        Display the attributes of a specific task (Task class), AgentService.get_task()
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Find task in service.tasks
            task = None
            for t in self.service.tasks.values():
                if t.task_id == task_id:
                    task = t
                    break
            
            if not task:
                flash('Task not found.', 'error')
                return redirect(url_for('tasks_list'))
            
            return render_template('task_view.html', task=task)
        except Exception as e:
            logger.error(f"Error in task_view: {str(e)}")
            flash(f'Error retrieving task: {str(e)}', 'error')
            return redirect(url_for('tasks_list'))

    def task_edit(self, task_id):
        '''
        Allow edit to each attribute of a Task, AgentService.update_task()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('description'):
                updates['description'] = request.form.get('description')
                
            contact_id_str = request.form.get('contact_id')
            if contact_id_str and contact_id_str.isdigit():
                updates['contact_id'] = int(contact_id_str)
                
            company_id_str = request.form.get('company_id')
            if company_id_str and company_id_str.isdigit():
                updates['company_id'] = int(company_id_str)
                
            if request.form.get('due_time'):
                updates['due_time'] = request.form.get('due_time')
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            
            if updates:
                self.service.update_task(task_id, **updates)
                flash('Task updated successfully!', 'success')
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in task_edit: {str(e)}")
            flash(f'Error updating task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def remove_task(self):
        '''
        Allow delete a task, AgentService.delete_task()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            task_id_str = request.form.get('task_id')
            if not task_id_str or not task_id_str.isdigit():
                flash('Invalid task ID.', 'error')
                return redirect(url_for('agent_home') + '#tasks-tab')
                
            task_id = int(task_id_str)
            
            if self.service.remove_task(task_id):
                flash('Task deleted successfully!', 'success')
            else:
                flash('Failed to delete task.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_task: {str(e)}")
            flash(f'Error deleting task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def mark_task_as_complete(self):
        '''
        Mark a task as complete, AgentService.update_task()
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            task_id_str = request.form.get('task_id')
            if not task_id_str or not task_id_str.isdigit():
                flash('Invalid task ID.', 'error')
                return redirect(url_for('agent_home') + '#tasks-tab')
                
            task_id = int(task_id_str)
            
            self.service.update_task(task_id, status='complete')
            flash('Task marked as complete!', 'success')
        except Exception as e:
            logger.error(f"Error in mark_task_as_complete: {str(e)}")
            flash(f'Error updating task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def add_task(self):
        '''
        Handle creation of a new task, AgentService.add_task()
        POST: Process the form submission and create a new task
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Task name is required.', 'error')
                return redirect(url_for('agent_home') + '#tasks-tab')
                
            description = request.form.get('description', '')
            
            contact_id_str = request.form.get('contact_id')
            contact_id = int(contact_id_str) if contact_id_str and contact_id_str.isdigit() else -1
            
            company_id_str = request.form.get('company_id')
            company_id = int(company_id_str) if company_id_str and company_id_str.isdigit() else -1
            
            due_time = request.form.get('due_time', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_task(
                assigned_agent_id=session['agent_id'],
                contact_id=contact_id,
                company_id=company_id,
                name=name,
                description=description,
                create_time=create_time,
                due_time=due_time,
                status='incomplete'
            )
            
            flash(f'Task "{name}" added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_task: {str(e)}")
            flash(f'Error adding task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def send_email(self):
        '''
        Handle composition and sending of a new email, AgentService.send_email()
        POST: Process the form submission and send the email
        -- redirect(url_for('agent_home') + '#email-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id_str = request.form.get('contact_id')
            if not contact_id_str or not contact_id_str.isdigit():
                flash('Invalid contact ID.', 'error')
                return redirect(url_for('agent_home') + '#email-tab')
                
            contact_id = int(contact_id_str)
            email_subject = request.form.get('subject', '')
            email_content = request.form.get('content', '')
            
            if self.service.send_email(contact_id, email_subject, email_content):
                flash('Email sent successfully!', 'success')
            else:
                flash('Failed to send email.', 'error')
        except Exception as e:
            logger.error(f"Error in send_email: {str(e)}")
            flash(f'Error sending email: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#email-tab')

    def settings(self):
        '''
        Handle agent settings.
        Display all attributes of Agent
        POST: Process the form submission and update settings
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        agent = self.service.show_setting()
        
        return render_template('settings.html', agent=agent, is_admin=session.get('is_admin', False))

    def agents_list(self):
        '''
        (admin only)
        Display the list of agents: AdminAgentService.get_all_agents()
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            # Get all agents
            self.admin_service.get_all_agents()
            agents = list(self.admin_service.agents.values())
            
            return render_template('agents_list.html', agents=agents)
        except Exception as e:
            logger.error(f"Error in agents_list: {str(e)}")
            flash(f'Error retrieving agents: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def agent_view(self, agent_id):
        '''
        (admin only)
        Display attributes about a specific agent (Agent class), AdminAgentService.get_agent()
        render_template('agent_view.html', agent_id=agent_id) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            agent = self.admin_service.get_agent(agent_id)
            return render_template('agent_view.html', agent=agent)
        except Exception as e:
            logger.error(f"Error in agent_view: {str(e)}")
            flash(f'Error retrieving agent: {str(e)}', 'error')
            return redirect(url_for('agents_list'))

    def agent_edit(self):
        '''
        (admin only)
        Allow edit to each attribute of a Agent, AdminAgentService.update_agent()
        All attribute that needed to be updated and agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            agent_id_str = request.form.get('agent_id')
            if not agent_id_str or not agent_id_str.isdigit():
                flash('Invalid agent ID.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            agent_id = int(agent_id_str)
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('email'):
                updates['email'] = request.form.get('email')
            if request.form.get('password'):
                updates['password'] = request.form.get('password')
            if request.form.get('phone'):
                updates['phone'] = request.form.get('phone')
            if request.form.get('org'):
                updates['org'] = request.form.get('org')
            if request.form.get('role'):
                updates['role'] = request.form.get('role')
                
            is_admin_str = request.form.get('is_admin')
            if is_admin_str is not None:
                updates['is_admin'] = is_admin_str.lower() == 'true'
            
            if updates:
                self.admin_service.update_agent(agent_id, **updates)
                flash('Agent updated successfully!', 'success')
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in agent_edit: {str(e)}")
            flash(f'Error updating agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

    def agent_delete(self, agent_id):
        '''
        (admin only)
        Allow delete an agent, AdminAgentService.delete_agent()
        Agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            # Prevent self-deletion
            if int(agent_id) == int(session['agent_id']):
                flash('Cannot delete your own account.', 'error')
                return redirect(url_for('agents_list'))
            
            if self.admin_service.remove_agent(agent_id):
                flash('Agent deleted successfully!', 'success')
            else:
                flash('Failed to delete agent.', 'error')
        except Exception as e:
            logger.error(f"Error in agent_delete: {str(e)}")
            flash(f'Error deleting agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

    def agent_new(self):
        '''
        (admin only)
        Handle creation of a new agent: AdminAgentService.add_agent()
        POST: Process the form submission and create a new agent
        All attribute that needed to be updated and agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Agent name is required.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            email = request.form.get('email', '')
            if not email:
                flash('Agent email is required.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            password = request.form.get('password', '')
            if not password:
                flash('Agent password is required.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            phone = request.form.get('phone', '')
            org = request.form.get('org', '')
            role = request.form.get('role', '')
            
            is_admin_str = request.form.get('is_admin', '')
            is_admin = is_admin_str.lower() == 'true' if is_admin_str else False
            
            self.admin_service.create_agent(
                name=name,
                email=email,
                password=password,
                phone=phone,
                org=org,
                role=role,
                is_admin=is_admin
            )
            
            flash(f'Agent {name} created successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in agent_new: {str(e)}")
            flash(f'Error creating agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

Review:

# Transpilation Review
The transpilation is mostly correct, but there are several type errors that need to be fixed. These errors involve assigning integer or float values to variables that are expected to be strings.

## Compilation Review
### Failures
The compilation errors are related to type mismatches in several places:

1. Line 341: Incompatible types in assignment (expression has type "int", target has type "str")
2. Line 344: Incompatible types in assignment (expression has type "float", target has type "str")
3. Line 396: Incompatible types in assignment (expression has type "int", target has type "str | None")
4. Line 401: Incompatible types in assignment (expression has type "float", target has type "str | None")
5. Line 671: Incompatible types in assignment (expression has type "int", target has type "str | None")
6. Line 965: Incompatible types in assignment (expression has type "int", target has type "str | None")
7. Line 969: Incompatible types in assignment (expression has type "int", target has type "str | None")
8. Line 1244: Incompatible types in assignment (expression has type "bool", target has type "str | None")

### Fixes
These errors can be fixed by converting the numeric values to strings before assignment:

1. In `update_companies()`: Convert `company_id` and `target_funding` to strings
2. In `update_company()`: Convert `main_contact_id` and `target_funding` to strings
3. In `update_contact()`: Convert `company_id` to string
4. In `add_task()`: Convert `contact_id` and `company_id` to strings
5. In `agent_edit()`: Convert `is_admin` to string

## Testing Review
No testing errors were provided in the prompt.

## Failures due to other causes
None identified based on the provided information.

## Dependency Analysis Review
The dependencies appear to be correctly imported and used in the code. The Routes class properly uses the AgentService and AdminAgentService interfaces, and all the necessary data models are imported.


---------------------------------------------
Step 7: Implementing the actual code (implementation and review):

Implemmentation:

"""Defines all routes for the Flask application, mapping URLs to view functions"""

import typing as t
from datetime import datetime
from flask import Flask, request, session, redirect, url_for, render_template, flash, jsonify
from backend_services.agent_service import AgentService
from backend_services.admin_service import AdminAgentService
from database.schema import Schema
from backend_services.data_models import Agent, CompanyNote, Company, Contact, ContactNote, Task, EmailTemplate
from database.db_operations import PostgresOperations
import logging

logger = logging.getLogger(__name__)


class Routes:
    '''
    This class defines all the route handlers for the CRM application.
    It handles routing for all pages including login, home, companies, contacts, tasks, email, settings, and admin pages.
    '''

    def __init__(self,
                 app: Flask,
                 agent_service: AgentService,
                 admin_service: t.Optional[AdminAgentService]=None,
                 ):
        '''
        Initialize the Routes class with the Flask app and all required services.

        Parameters:
        - app: The Flask application instance
        - agent_service: Services for an agent
        - admin_agent_service: Services for an admin agent (who can do whatever an agent can do and add/remove agent)
        '''
        self.app = app
        self.agent_service = agent_service
        self.admin_service = admin_service
        self.service = self.agent_service
        self.register_routes()

    def register_routes(self) -> None:
        '''
        Register all route handlers with the Flask application.
        This method sets up all the URL routes and connects them to their respective handler methods, defined below
        '''
        # Authentication routes
        self.app.route('/')(self.home)
        self.app.route('/login', methods=['GET', 'POST'])(self.login)
        self.app.route('/logout')(self.logout)
        
        # Agent home
        self.app.route('/agent/home')(self.agent_home)
        
        # Company routes
        self.app.route('/companies')(self.companies_list)
        self.app.route('/companies/add', methods=['POST'])(self.add_company)
        self.app.route('/companies/<int:company_id>')(self.company_view)
        self.app.route('/companies/update', methods=['POST'])(self.update_companies)
        self.app.route('/company/update', methods=['POST'])(self.update_company)
        self.app.route('/company/remove', methods=['POST'])(self.remove_company)
        
        # Company notes routes
        self.app.route('/companies/<int:company_id>/notes/add', methods=['POST'])(self.add_company_note)
        self.app.route('/companies/<int:company_id>/notes/edit', methods=['POST'])(self.company_note_edit)
        self.app.route('/companies/<int:company_id>/notes/remove', methods=['POST'])(self.remove_company_note)
        
        # Contact routes
        self.app.route('/contacts')(self.contacts_list)
        self.app.route('/contacts/<int:contact_id>')(self.contact_view)
        self.app.route('/contact/update', methods=['POST'])(self.update_contact)
        self.app.route('/contact/remove', methods=['POST'])(self.remove_contact)
        self.app.route('/contact/add', methods=['POST'])(self.add_contact)
        
        # Contact notes routes
        self.app.route('/contacts/<int:contact_id>/notes/add', methods=['POST'])(self.add_contact_note)
        self.app.route('/contacts/<int:contact_id>/notes/edit', methods=['POST'])(self.contact_note_edit)
        self.app.route('/contacts/<int:contact_id>/notes/remove', methods=['POST'])(self.remove_contact_note)
        
        # Task routes
        self.app.route('/tasks')(self.tasks_list)
        self.app.route('/tasks/<int:task_id>')(self.task_view)
        self.app.route('/tasks/<int:task_id>/edit', methods=['POST'])(self.task_edit)
        self.app.route('/task/remove', methods=['POST'])(self.remove_task)
        self.app.route('/task/complete', methods=['POST'])(self.mark_task_as_complete)
        self.app.route('/task/add', methods=['POST'])(self.add_task)
        
        # Email routes
        self.app.route('/email/send', methods=['POST'])(self.send_email)
        
        # Settings routes
        self.app.route('/settings')(self.settings)
        
        # Admin routes
        self.app.route('/admin/agents')(self.agents_list)
        self.app.route('/admin/agents/<int:agent_id>')(self.agent_view)
        self.app.route('/admin/agent/edit', methods=['POST'])(self.agent_edit)
        self.app.route('/admin/agent/<int:agent_id>/delete')(self.agent_delete)
        self.app.route('/admin/agent/new', methods=['POST'])(self.agent_new)

    def home(self):
        '''
        The home for the Flask application. Redirects to login
        '''
        if 'agent_id' in session:
            return redirect(url_for('agent_home'))
        return redirect(url_for('login'))

    def login(self):
        '''
        Handle user login for both agents and admins.

        GET: Display the login form
        POST: Process the login form submission

        If login is successful, redirect to the agent_home or admin_home page accordingly.
        If login fails, show an error message and redisplay the login form.

        Uses AgentService.login or AdminService.login to verify credentials.
        '''
        if request.method == 'POST':
            agent_id_str = request.form.get('agent_id')
            agent_id = int(agent_id_str) if agent_id_str and agent_id_str.isdigit() else -1
            agent_email = request.form.get('agent_email', '')
            password = request.form.get('password', '')
            
            # Try admin login first if admin service is available
            if self.admin_service and self.admin_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.admin_service.agent_id
                session['is_admin'] = True
                self.service = self.admin_service
                flash('Admin login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            # Try regular agent login
            if self.agent_service.login(agent_id, agent_email, password):
                session['agent_id'] = self.agent_service.agent_id
                session['is_admin'] = False
                self.service = self.agent_service
                flash('Login successful!', 'success')
                return redirect(url_for('agent_home'))
            
            flash('Invalid credentials. Please try again.', 'error')
        
        return render_template('login.html')

    def logout(self):
        '''
        Handle user logout.
        Clear the user session and redirect to the login page.
        '''
        if 'is_admin' in session and session['is_admin'] and self.admin_service:
            self.admin_service.logout()
        else:
            self.agent_service.logout()
        
        session.clear()
        self.service = self.agent_service
        flash('You have been logged out.', 'info')
        return redirect(url_for('login'))

    def agent_home(self):
        '''
        Display the home/start page of the agent. Render agent_home.html
        On top of this page, show a dashboard with
        - Home: return to this page.
        - Companies: go to companies_list
        - Contacts: go to contacts_list
        - Tasks: go to tasks_list
        - Email: go to email_page
        - Settings: go to settings_list
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        agent = self.service.show_setting()
        
        return render_template('agent_home.html', agent=agent, is_admin=session.get('is_admin', False))

    def companies_list(self):
        '''
        Display the list of companies, AgentService.get_all_companies()

        Shows a paginated, sortable, and filterable list of companies.
        Includes search functionality.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        # Get sorting preference from query parameters
        order_by_target_funding = request.args.get('order_by_target_funding', 'false').lower() == 'true'
        
        try:
            # Get companies
            self.service.get_all_companies(order_by_target_funding=order_by_target_funding)
            companies = list(self.service.companies.values())
            
            return render_template('companies_list.html', companies=companies)
        except Exception as e:
            logger.error(f"Error in companies_list: {str(e)}")
            flash(f'Error retrieving companies: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def add_company(self):
        '''
        Add a new company to the service and database, using self.service.add_company()
        All attribute, expect for company_id will be read from the request form.
        Users will not specify company_id.
        E.g. main_contact_id = int(request.form.get("main_contact_id")).
        -- redirect(url_for('agent_home')) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Company name is required.', 'error')
                return redirect(url_for('agent_home'))
                
            main_contact_id_str = request.form.get('main_contact_id')
            main_contact_id = int(main_contact_id_str) if main_contact_id_str and main_contact_id_str.isdigit() else -1
            
            target_funding_str = request.form.get('target_funding')
            target_funding = float(target_funding_str) if target_funding_str else 0.0
            
            grant_type = request.form.get('grant_type', '')
            status = request.form.get('status', 'New')
            renewal_date = request.form.get('renewal_date', '')
            
            company = self.service.add_company(
                name=name,
                main_contact_id=main_contact_id,
                target_funding=target_funding,
                grant_type=grant_type,
                status=status,
                renewal_date=renewal_date
            )
            
            flash(f'Company {name} added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_company: {str(e)}")
            flash(f'Error adding company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def company_view(self, company_id):
        '''
        View one company.
        Display all attribute about a specific company (Company class), AgentService.get_company()
        Display all notes (self.service.get_company_notes(company_id, order_by_create_date=True))
                and contacts for this company (self.service.show_all_company_contacts(company_id))
        Render company_view.html
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company = self.service.get_company(company_id)
            notes = self.service.get_company_notes(company_id, order_by_create_date=True)
            contacts = self.service.show_all_company_contacts(company_id)
            tasks = self.service.show_all_company_tasks(company_id)
            
            return render_template(
                'company_view.html',
                company=company,
                notes=notes,
                contacts=contacts,
                tasks=tasks
            )
        except Exception as e:
            logger.error(f"Error in company_view: {str(e)}")
            flash(f'Error retrieving company: {str(e)}', 'error')
            return redirect(url_for('companies_list'))

    def update_companies(self):
        '''
        Allow edit to each attribute of many Company, call AgentService.update_company() in a for loop,
            for each modified company.
        All attribute that needed to be updated and company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_ids = request.form.getlist('company_id')
            names = request.form.getlist('name')
            main_contact_ids = request.form.getlist('main_contact_id')
            target_fundings = request.form.getlist('target_funding')
            grant_types = request.form.getlist('grant_type')
            statuses = request.form.getlist('status')
            renewal_dates = request.form.getlist('renewal_date')
            
            for i in range(len(company_ids)):
                company_id_str = company_ids[i]
                if not company_id_str or not company_id_str.isdigit():
                    continue
                    
                company_id = int(company_id_str)
                updates = {}
                
                if i < len(names) and names[i]:
                    updates['name'] = names[i]
                if i < len(main_contact_ids) and main_contact_ids[i] and main_contact_ids[i].isdigit():
                    updates['main_contact_id'] = int(main_contact_ids[i])
                if i < len(target_fundings) and target_fundings[i]:
                    try:
                        updates['target_funding'] = float(target_fundings[i])
                    except ValueError:
                        pass
                if i < len(grant_types) and grant_types[i]:
                    updates['grant_type'] = grant_types[i]
                if i < len(statuses) and statuses[i]:
                    updates['status'] = statuses[i]
                if i < len(renewal_dates) and renewal_dates[i]:
                    updates['renewal_date'] = renewal_dates[i]
                
                if updates:
                    self.service.update_company(company_id, **updates)
            
            flash('Companies updated successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in update_companies: {str(e)}")
            flash(f'Error updating companies: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def update_company(self):
        '''
        Allow edit to each attribute of a Company, AgentService.update_company()
        All attribute that needed to be updated and company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_id_str = request.form.get('company_id')
            if not company_id_str or not company_id_str.isdigit():
                flash('Invalid company ID.', 'error')
                return redirect(url_for('agent_home'))
                
            company_id = int(company_id_str)
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
                
            main_contact_id_str = request.form.get('main_contact_id')
            if main_contact_id_str and main_contact_id_str.isdigit():
                updates['main_contact_id'] = int(main_contact_id_str)
                
            target_funding_str = request.form.get('target_funding')
            if target_funding_str:
                try:
                    updates['target_funding'] = float(target_funding_str)
                except ValueError:
                    pass
                    
            if request.form.get('grant_type'):
                updates['grant_type'] = request.form.get('grant_type')
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            if request.form.get('renewal_date'):
                updates['renewal_date'] = request.form.get('renewal_date')
            
            if updates:
                self.service.update_company(company_id, **updates)
                flash('Company updated successfully!', 'success')
                return redirect(url_for('company_view', company_id=company_id))
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in update_company: {str(e)}")
            flash(f'Error updating company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def remove_company(self):
        '''
        Allow delete a company, AgentService.remove_company()
        The company_id will be read from the request form.
        e.g., company_id = int(request.form.get("company_id"))
        -- redirect(url_for('agent_home')) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_id_str = request.form.get('company_id')
            if not company_id_str or not company_id_str.isdigit():
                flash('Invalid company ID.', 'error')
                return redirect(url_for('agent_home'))
                
            company_id = int(company_id_str)
            
            if self.service.remove_company(company_id):
                flash('Company deleted successfully!', 'success')
            else:
                flash('Failed to delete company.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_company: {str(e)}")
            flash(f'Error deleting company: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def company_note_edit(self, company_id: int):
        '''
        Allow edit to each attribute of a CompanyNote, AgentService.update_company_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_note_id_str = request.form.get('company_note_id')
            if not company_note_id_str or not company_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('agent_home'))
                
            company_note_id = int(company_note_id_str)
            new_note = request.form.get('note', '')
            
            self.service.update_company_note(
                company_id=company_id,
                company_note_id=company_note_id,
                new_note=new_note
            )
            
            flash('Note updated successfully!', 'success')
            return redirect(url_for('company_view', company_id=company_id))
        except Exception as e:
            logger.error(f"Error in company_note_edit: {str(e)}")
            flash(f'Error updating note: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def remove_company_note(self, company_id: int):
        '''
        Allow delete a CompanyNote, AgentService.delete_company_note()
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            company_note_id_str = request.form.get('company_note_id')
            if not company_note_id_str or not company_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('company_view', company_id=company_id))
                
            company_note_id = int(company_note_id_str)
            
            if self.service.remove_company_note(company_id, company_note_id):
                flash('Note deleted successfully!', 'success')
                return redirect(url_for('company_view', company_id=company_id))
            else:
                flash('Failed to delete note.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_company_note: {str(e)}")
            flash(f'Error deleting note: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def add_company_note(self, company_id: int):
        '''
        Handle creation of a new company note.
        POST: Process the form submission and create a new company note
        Uses AgentService.add_company_note() to create the company note.
        -- redirect(url_for('company_view', company_id=company_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            new_note = request.form.get('note', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_company_note(
                company_id=company_id,
                new_note=new_note,
                create_time=create_time
            )
            
            flash('Note added successfully!', 'success')
            return redirect(url_for('company_view', company_id=company_id))
        except Exception as e:
            logger.error(f"Error in add_company_note: {str(e)}")
            flash(f'Error adding note: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def contacts_list(self):
        '''
        Display the list of contacts, AgentService.get_all_contacts()
        Shows a paginated, sortable, and filterable list of contacts.
        Includes search functionality.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Get sorting preference from query parameters
            sort_by_companies = request.args.get('sort_by_companies', 'true').lower() == 'true'
            
            # Get contacts
            self.service.get_all_contacts(sort_by_companies=sort_by_companies)
            contacts = list(self.service.contacts.values())
            
            return render_template('contacts_list.html', contacts=contacts)
        except Exception as e:
            logger.error(f"Error in contacts_list: {str(e)}")
            flash(f'Error retrieving contacts: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def contact_view(self, contact_id):
        '''
        Display detailed information about a specific contact, AgentService.get_contact()
        Shows all attribute of a Contact class:
        Show all contact notes, AgentService.get_contact_notes()
        render_template('contact_view.html') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact = self.service.get_contact(contact_id)
            notes = self.service.get_contact_notes(contact_id)
            
            # Get company if available
            company = None
            if contact.company_id > 0:
                try:
                    company = self.service.get_company(contact.company_id)
                except Exception:
                    pass
            
            return render_template(
                'contact_view.html',
                contact=contact,
                notes=notes,
                company=company
            )
        except Exception as e:
            logger.error(f"Error in contact_view: {str(e)}")
            flash(f'Error retrieving contact: {str(e)}', 'error')
            return redirect(url_for('contacts_list'))

    def update_contact(self):
        '''
        Allow edit to each attribute of a Contact, AgentService.update_contact()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end if successful
           else redirect(url_for('agent_home'))
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id_str = request.form.get('contact_id')
            if not contact_id_str or not contact_id_str.isdigit():
                flash('Invalid contact ID.', 'error')
                return redirect(url_for('agent_home'))
                
            contact_id = int(contact_id_str)
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('email'):
                updates['email'] = request.form.get('email')
                
            company_id_str = request.form.get('company_id')
            if company_id_str and company_id_str.isdigit():
                updates['company_id'] = int(company_id_str)
                
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            
            if updates:
                self.service.update_contact(contact_id, **updates)
                flash('Contact updated successfully!', 'success')
                return redirect(url_for('contact_view', contact_id=contact_id))
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in update_contact: {str(e)}")
            flash(f'Error updating contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home'))

    def remove_contact(self):
        '''
        Allow delete a contact, AgentService.remove_contact()
        contact_id be read from the request form.
        -- redirect(url_for('agent_home') + '#contacts-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id_str = request.form.get('contact_id')
            if not contact_id_str or not contact_id_str.isdigit():
                flash('Invalid contact ID.', 'error')
                return redirect(url_for('agent_home') + '#contacts-tab')
                
            contact_id = int(contact_id_str)
            
            if self.service.remove_contact(contact_id):
                flash('Contact deleted successfully!', 'success')
            else:
                flash('Failed to delete contact.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_contact: {str(e)}")
            flash(f'Error deleting contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#contacts-tab')

    def add_contact(self):
        '''
        Handle creation of a new contact, AgentService.add_contact()
        POST: Process the form submission and create a new contact
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#contacts-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Contact name is required.', 'error')
                return redirect(url_for('agent_home') + '#contacts-tab')
                
            email = request.form.get('email', '')
            if not email:
                flash('Contact email is required.', 'error')
                return redirect(url_for('agent_home') + '#contacts-tab')
                
            company_id_str = request.form.get('company_id')
            company_id = int(company_id_str) if company_id_str and company_id_str.isdigit() else -1
            
            status = request.form.get('status', 'new')
            
            contact = self.service.add_contact(
                name=name,
                email=email,
                company_id=company_id,
                assigned_agent_id=session['agent_id'],
                status=status
            )
            
            flash(f'Contact {name} added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_contact: {str(e)}")
            flash(f'Error adding contact: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#contacts-tab')

    def contact_note_edit(self, contact_id):
        '''
        Allow edit to each attribute of a ContactNote, AgentService.update_contact_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_note_id_str = request.form.get('contact_note_id')
            if not contact_note_id_str or not contact_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('contact_view', contact_id=contact_id))
                
            contact_note_id = int(contact_note_id_str)
            new_note = request.form.get('note', '')
            
            self.service.update_contact_note(
                contact_id=contact_id,
                contact_note_id=contact_note_id,
                note=new_note
            )
            
            flash('Note updated successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in contact_note_edit: {str(e)}")
            flash(f'Error updating note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def remove_contact_note(self, contact_id):
        '''
        Allow delete a Contact Note, AgentService.remove_contact_note()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_note_id_str = request.form.get('contact_note_id')
            if not contact_note_id_str or not contact_note_id_str.isdigit():
                flash('Invalid note ID.', 'error')
                return redirect(url_for('contact_view', contact_id=contact_id))
                
            contact_note_id = int(contact_note_id_str)
            
            if self.service.remove_contact_note(contact_id, contact_note_id):
                flash('Note deleted successfully!', 'success')
            else:
                flash('Failed to delete note.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_contact_note: {str(e)}")
            flash(f'Error deleting note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def add_contact_note(self, contact_id):
        '''
        Handle creation of a new contact note, AgentService.add_contact_note()
        POST: Process the form submission and create a new contact note
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('contact_view', contact_id=contact_id)) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            new_note = request.form.get('note', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_contact_note(
                contact_id=contact_id,
                new_note=new_note,
                assigned_agent_id=session['agent_id'],
                create_time=create_time
            )
            
            flash('Note added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_contact_note: {str(e)}")
            flash(f'Error adding note: {str(e)}', 'error')
        
        return redirect(url_for('contact_view', contact_id=contact_id))

    def tasks_list(self):
        '''
        Display the list of tasks, AgentService.get_all_tasks()
        Shows a paginated, sortable, and filterable list of tasks.
        Includes search functionality and filtering by status, priority, and due date.
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Get sorting preference from query parameters
            order_by_due_date = request.args.get('order_by_due_date', 'true').lower() == 'true'
            
            # Get tasks
            self.service.get_all_tasks(order_by_due_date=order_by_due_date)
            tasks = list(self.service.tasks.values())
            
            return render_template('tasks_list.html', tasks=tasks)
        except Exception as e:
            logger.error(f"Error in tasks_list: {str(e)}")
            flash(f'Error retrieving tasks: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def task_view(self, task_id):
        '''
        Display the attributes of a specific task (Task class), AgentService.get_task()
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            # Find task in service.tasks
            task = None
            for t in self.service.tasks.values():
                if t.task_id == task_id:
                    task = t
                    break
            
            if not task:
                flash('Task not found.', 'error')
                return redirect(url_for('tasks_list'))
            
            return render_template('task_view.html', task=task)
        except Exception as e:
            logger.error(f"Error in task_view: {str(e)}")
            flash(f'Error retrieving task: {str(e)}', 'error')
            return redirect(url_for('tasks_list'))

    def task_edit(self, task_id):
        '''
        Allow edit to each attribute of a Task, AgentService.update_task()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('description'):
                updates['description'] = request.form.get('description')
                
            contact_id_str = request.form.get('contact_id')
            if contact_id_str and contact_id_str.isdigit():
                updates['contact_id'] = int(contact_id_str)
                
            company_id_str = request.form.get('company_id')
            if company_id_str and company_id_str.isdigit():
                updates['company_id'] = int(company_id_str)
                
            if request.form.get('due_time'):
                updates['due_time'] = request.form.get('due_time')
            if request.form.get('status'):
                updates['status'] = request.form.get('status')
            
            if updates:
                self.service.update_task(task_id, **updates)
                flash('Task updated successfully!', 'success')
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in task_edit: {str(e)}")
            flash(f'Error updating task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def remove_task(self):
        '''
        Allow delete a task, AgentService.delete_task()
        All attribute that needed to be updated and company_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            task_id_str = request.form.get('task_id')
            if not task_id_str or not task_id_str.isdigit():
                flash('Invalid task ID.', 'error')
                return redirect(url_for('agent_home') + '#tasks-tab')
                
            task_id = int(task_id_str)
            
            if self.service.remove_task(task_id):
                flash('Task deleted successfully!', 'success')
            else:
                flash('Failed to delete task.', 'error')
        except Exception as e:
            logger.error(f"Error in remove_task: {str(e)}")
            flash(f'Error deleting task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def mark_task_as_complete(self):
        '''
        Mark a task as complete, AgentService.update_task()
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            task_id_str = request.form.get('task_id')
            if not task_id_str or not task_id_str.isdigit():
                flash('Invalid task ID.', 'error')
                return redirect(url_for('agent_home') + '#tasks-tab')
                
            task_id = int(task_id_str)
            
            self.service.update_task(task_id, status='complete')
            flash('Task marked as complete!', 'success')
        except Exception as e:
            logger.error(f"Error in mark_task_as_complete: {str(e)}")
            flash(f'Error updating task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def add_task(self):
        '''
        Handle creation of a new task, AgentService.add_task()
        POST: Process the form submission and create a new task
        -- redirect(url_for('agent_home') + '#tasks-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Task name is required.', 'error')
                return redirect(url_for('agent_home') + '#tasks-tab')
                
            description = request.form.get('description', '')
            
            contact_id_str = request.form.get('contact_id')
            contact_id = int(contact_id_str) if contact_id_str and contact_id_str.isdigit() else -1
            
            company_id_str = request.form.get('company_id')
            company_id = int(company_id_str) if company_id_str and company_id_str.isdigit() else -1
            
            due_time = request.form.get('due_time', '')
            create_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            self.service.add_task(
                assigned_agent_id=session['agent_id'],
                contact_id=contact_id,
                company_id=company_id,
                name=name,
                description=description,
                create_time=create_time,
                due_time=due_time,
                status='incomplete'
            )
            
            flash(f'Task "{name}" added successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in add_task: {str(e)}")
            flash(f'Error adding task: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#tasks-tab')

    def send_email(self):
        '''
        Handle composition and sending of a new email, AgentService.send_email()
        POST: Process the form submission and send the email
        -- redirect(url_for('agent_home') + '#email-tab') in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        try:
            contact_id_str = request.form.get('contact_id')
            if not contact_id_str or not contact_id_str.isdigit():
                flash('Invalid contact ID.', 'error')
                return redirect(url_for('agent_home') + '#email-tab')
                
            contact_id = int(contact_id_str)
            email_subject = request.form.get('subject', '')
            email_content = request.form.get('content', '')
            
            if self.service.send_email(contact_id, email_subject, email_content):
                flash('Email sent successfully!', 'success')
            else:
                flash('Failed to send email.', 'error')
        except Exception as e:
            logger.error(f"Error in send_email: {str(e)}")
            flash(f'Error sending email: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#email-tab')

    def settings(self):
        '''
        Handle agent settings.
        Display all attributes of Agent
        POST: Process the form submission and update settings
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        # Set the appropriate service based on user type
        if session.get('is_admin', False) and self.admin_service:
            self.service = self.admin_service
        else:
            self.service = self.agent_service
        
        agent = self.service.show_setting()
        
        return render_template('settings.html', agent=agent, is_admin=session.get('is_admin', False))

    def agents_list(self):
        '''
        (admin only)
        Display the list of agents: AdminAgentService.get_all_agents()
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            # Get all agents
            self.admin_service.get_all_agents()
            agents = list(self.admin_service.agents.values())
            
            return render_template('agents_list.html', agents=agents)
        except Exception as e:
            logger.error(f"Error in agents_list: {str(e)}")
            flash(f'Error retrieving agents: {str(e)}', 'error')
            return redirect(url_for('agent_home'))

    def agent_view(self, agent_id):
        '''
        (admin only)
        Display attributes about a specific agent (Agent class), AdminAgentService.get_agent()
        render_template('agent_view.html', agent_id=agent_id) in the end
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            agent = self.admin_service.get_agent(agent_id)
            return render_template('agent_view.html', agent=agent)
        except Exception as e:
            logger.error(f"Error in agent_view: {str(e)}")
            flash(f'Error retrieving agent: {str(e)}', 'error')
            return redirect(url_for('agents_list'))

    def agent_edit(self):
        '''
        (admin only)
        Allow edit to each attribute of a Agent, AdminAgentService.update_agent()
        All attribute that needed to be updated and agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            agent_id_str = request.form.get('agent_id')
            if not agent_id_str or not agent_id_str.isdigit():
                flash('Invalid agent ID.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            agent_id = int(agent_id_str)
            updates = {}
            
            if request.form.get('name'):
                updates['name'] = request.form.get('name')
            if request.form.get('email'):
                updates['email'] = request.form.get('email')
            if request.form.get('password'):
                updates['password'] = request.form.get('password')
            if request.form.get('phone'):
                updates['phone'] = request.form.get('phone')
            if request.form.get('org'):
                updates['org'] = request.form.get('org')
            if request.form.get('role'):
                updates['role'] = request.form.get('role')
                
            is_admin_str = request.form.get('is_admin')
            if is_admin_str is not None:
                updates['is_admin'] = is_admin_str.lower() == 'true'
            
            if updates:
                self.admin_service.update_agent(agent_id, **updates)
                flash('Agent updated successfully!', 'success')
            else:
                flash('No updates provided.', 'warning')
        except Exception as e:
            logger.error(f"Error in agent_edit: {str(e)}")
            flash(f'Error updating agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

    def agent_delete(self, agent_id):
        '''
        (admin only)
        Allow delete an agent, AdminAgentService.delete_agent()
        Agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            # Prevent self-deletion
            if int(agent_id) == int(session['agent_id']):
                flash('Cannot delete your own account.', 'error')
                return redirect(url_for('agents_list'))
            
            if self.admin_service.remove_agent(agent_id):
                flash('Agent deleted successfully!', 'success')
            else:
                flash('Failed to delete agent.', 'error')
        except Exception as e:
            logger.error(f"Error in agent_delete: {str(e)}")
            flash(f'Error deleting agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

    def agent_new(self):
        '''
        (admin only)
        Handle creation of a new agent: AdminAgentService.add_agent()
        POST: Process the form submission and create a new agent
        All attribute that needed to be updated and agent_id will be read from the request form.
        -- redirect(url_for('agent_home') + '#agents-tab')
        '''
        if 'agent_id' not in session:
            flash('Please login first.', 'error')
            return redirect(url_for('login'))
        
        if not session.get('is_admin', False) or not self.admin_service:
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('agent_home'))
        
        try:
            name = request.form.get('name', '')
            if not name:
                flash('Agent name is required.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            email = request.form.get('email', '')
            if not email:
                flash('Agent email is required.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            password = request.form.get('password', '')
            if not password:
                flash('Agent password is required.', 'error')
                return redirect(url_for('agent_home') + '#agents-tab')
                
            phone = request.form.get('phone', '')
            org = request.form.get('org', '')
            role = request.form.get('role', '')
            
            is_admin_str = request.form.get('is_admin', '')
            is_admin = is_admin_str.lower() == 'true' if is_admin_str else False
            
            self.admin_service.create_agent(
                name=name,
                email=email,
                password=password,
                phone=phone,
                org=org,
                role=role,
                is_admin=is_admin
            )
            
            flash(f'Agent {name} created successfully!', 'success')
        except Exception as e:
            logger.error(f"Error in agent_new: {str(e)}")
            flash(f'Error creating agent: {str(e)}', 'error')
        
        return redirect(url_for('agent_home') + '#agents-tab')

Review:

# Transpilation Review
The transpilation is mostly correct, but there are several type errors that need to be fixed. These errors are related to type conversions between integers, floats, and strings.

## Compilation Review
### Failures
1. Line 341: Incompatible types in assignment (expression has type "int", target has type "str")
2. Line 344: Incompatible types in assignment (expression has type "float", target has type "str")
3. Line 396: Incompatible types in assignment (expression has type "int", target has type "str | None")
4. Line 401: Incompatible types in assignment (expression has type "float", target has type "str | None")
5. Line 671: Incompatible types in assignment (expression has type "int", target has type "str | None")
6. Line 965: Incompatible types in assignment (expression has type "int", target has type "str | None")
7. Line 969: Incompatible types in assignment (expression has type "int", target has type "str | None")
8. Line 1244: Incompatible types in assignment (expression has type "bool", target has type "str | None")

### Fixes
These errors are all related to type conversions. In Python, when retrieving form data or query parameters, the values are always strings. When we need to convert them to integers, floats, or booleans, we need to do explicit conversions. However, the current code is trying to assign the converted values back to the original string variables, which causes type errors.

The fixes involve:
1. Creating new variables with appropriate names for the converted values
2. Using the converted values in the function calls
3. Not reassigning to the original string variables

For example, instead of:
```python
main_contact_id = request.form.get('main_contact_id')
main_contact_id = int(main_contact_id) if main_contact_id and main_contact_id.isdigit() else -1
```

We should use:
```python
main_contact_id_str = request.form.get('main_contact_id')
main_contact_id = int(main_contact_id_str) if main_contact_id_str and main_contact_id_str.isdigit() else -1
```

## Testing Review
No testing errors were provided in the prompt.

## Failures due to other causes
None identified based on the provided information.

## Dependency Analysis Review
The dependencies look correct. The file imports all necessary modules and classes:
- Flask and related modules for web functionality
- Backend services for business logic
- Database operations for data access
- Logging for error tracking

The file correctly uses these dependencies throughout the implementation.

